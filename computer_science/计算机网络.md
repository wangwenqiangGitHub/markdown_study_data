概述

## 因特网概述

### 网络、互联网和因特网

> * 网络(Network)：由若干结点(Node)和连接这些结点的链路(Link)组成。
>
> * 多个网络还可以通过路由器互连起来，这样就构成了一个覆盖范围更大的网络，即互联网（互连网）。
>
>   互联网是网络的网络
>
>   因特网(Internet)是世界上最大的互连网络(用户数以亿计，互连的网络数以百万计)。

internet(互联网)：是一个通用名词，泛指由多个计算机网络互连而成的网络，在这些网络之间的通信协议可以是任意的。

Internet(因特网)：是一个专用名词，指当前全球最大的、开放的由从多网络相互连接而成的特定计算机网络，它采用TCP/IP协议族作为通信规则，其前身是美国的ARPANET。

![ ](https://i.loli.net/2021/04/22/ONSTib8XlexRg49.png)

### 因特网的组成

> * 边缘部分：由所有连接在因特网上的主机组成。这部分是用户直接使用的，用来进行通信（传送数据、音频或视频）和资源共享。
> * 核心部分：由大量网络和连接这些网络的路由器组成。这部分是为边缘部他分提供服务的（提供连通性和交换）。

## 三种交换方式

### 电路交换(Circuit Switching)

> * 电话交换机接通电话线的方式称为电路交换
> * 从通信资源的分配角度来看，交换就是按照某种方式动态地分配传输线路的资源
> * 电路交换的三个步骤：
>   * 建立连接(分配通信资源)
>   * 通话(一直占用通信资源)
>   * 释放连接(归还通信资源)

### 分组交换(Packet Switching)

![image-20210217104403601](https://i.loli.net/2021/04/22/ONSTib8XlexRg49.png)

### 报文交换(Message Switching)

### 对比

![image-20210217114702367](https://i.loli.net/2021/02/17/qHnaCZsT9zUR3e2.png)

## 计算机网络

### 定义

> 计算机网络的最简单定义是：一些互相连接的、自治的计算机的集合。
>
> * 互连：是指计算机之间可以通过有线或无线的方式进行数据通信
> * 自治：是指独立的计算机，它有自己的硬件和软件，可以单独运行使用
> * 集合：是指至少需要两台计算机

计算机网络的较好的定义是：计算机网络主要是由一些通用的、可编程的硬件互连而成的，而这些硬件并非专门用来实现某一特定目的(例如，传送数据或视频信号)。这些可编程的硬件能够用来传送多种不同类型的数据，并能支持广泛的和日益增长的应用。

### 分类

* 按交换技术分类
  * 电路交换网络
  * 报文交换网络
  * 分组交换网络
* 按使用者分类
  * 公用网
  * 专用网
* 按传输介质分类
  * 有线网络
  * 无线网络
* 按覆盖范围分类
  * 广域网WAN
  * 城域网MAN
  * 局域网LAN
  * 个域网PAN
* 按拓扑结构分类
  * 总线型
  * 星型
  * 环型
  * 网状型

## 计算机网络性能指标

### 速率（速度概念）

* ==连接在计算机网络上的主机在数字信道上传送比特的速率，也称为比特率或数据率。bit/s，b/s，bps==

  $$ kb/s = 10^3 b/s $$

  $$Mb/s = 10^3kb/s$$

  ......

  ![image-20210217145615730](https://i.loli.net/2021/02/17/AGZg3jUtOxcBCrT.png)

### ==带宽（速度概念）==

* 带宽在模拟信号系统中的意义：信号所包含的各种不同频率成分所占据的频率范围
* 单位：Hz(KHz, MHz, GHz)
* 带宽在计算机网络中的意义：==用来表示网络的通信线路所能传送数据的能力，因此网络带宽表示在单位时间内从网络中的某一点到另一点所能通过的“最高数据率”==
* 单位：b/s， kb/s等

一条线路的“频带宽度”越宽，其所传输数据的“最高数据率”也越高。

### 吞吐量

* ==在单位时间内通过某个网络（或信道、接口）的数据量。==
* 其受网络带宽或额定速率的限制。

### ==时延（时间概念）==

![image-20210217185940057](https://i.loli.net/2021/02/17/uhIZoE9RH3NwP2c.png)

![image-20210217190010989](https://i.loli.net/2021/02/17/OKA3nhfW1Ly8PVS.png)

### 时延带宽积

* 传播时延与带宽的积
* 若发送端连续发送数据，则在所发送的第一个比特到达终点时，发送端就已经发送了时延带宽积个比特，时延单位是时间，带宽相当于速度。比特就相当于路程。
* 链路的时延带宽积又称为以比特为单位的链路长度。

### 往返时间

* 很多时候，因特网上的信息是双向交互
* RTT(Round-Trip Time)

### ==利用率==

![image-20210217192240093](https://i.loli.net/2021/02/17/RJFNZfwzqeUtyPg.png)

### 丢包率

![image-20210217193335319](https://i.loli.net/2021/02/17/NQjUnrlya6Y1JwF.png)

## 计算机网络体系结构

### 1. 常见的计算机网络体系结构

#### OSI的七层体系结构：

#### TCP/IP的四层体系结构：



![image-20210218083617811](https://i.loli.net/2021/04/22/datL5ScvR1PjhfK.png)

![image-20210218110020837](https://i.loli.net/2021/04/22/tPz61dBrcyiFAxS.png)

#### 五层原理体系结构：

![image-20210218084147606](https://i.loli.net/2021/04/22/orQxlbHePzDRBES.png)

![image-20210218084440927](https://i.loli.net/2021/04/22/EHBzT6g5fawC8PX.png)

TCP向应用层相应协议提供可靠传输服务

UDP向应用层相应协议提供不可靠传输服务

### 2. 计算机网络体系结构分层的必要性

![image-20210218090225724](https://i.loli.net/2021/04/22/zF1eBrHjLoiDbf2.png)、

严格来说传输媒体不属于物理层，也不包含在计算机网络体系结构中

信号也不是方波信号

![image-20210218090634771](https://i.loli.net/2021/04/22/pl2tnw5rBudHJhT.png)

![image-20210218101005826](https://i.loli.net/2021/04/22/4tqsp8X1BrNA9OM.png)

![image-20210218101029874](https://i.loli.net/2021/04/22/W6i9ldFuyj5c3Ba.png)

![image-20210218101109796](https://i.loli.net/2021/04/22/9LapKN5v1nQfrWs.png)

![image-20210218101148921](https://i.loli.net/2021/04/22/9wI58KqNXel1ARp.png)

### 3. 计算机网络体系结构分层思想举例

[B站地址]("https://www.bilibili.com/video/BV1c4411d7jb?t=412&p=9")

本地地址：E:\video\TCP

### 4. 计算机网络体系结构中的专用术语

#### 实体

![image-20210218094316602](https://i.loli.net/2021/04/22/qeZxwsMDNkl2Af1.png)



#### 协议

![image-20210218094354211](https://i.loli.net/2021/04/22/boZXG4qBMu8WpwV.png)

之所以称为逻辑通信，是因为这种通信其实不存在，这样只是为了方便单独研究体系结构的某一层时，不用考虑其它层。

##### 协议三要素

![image-20210218094551004](https://i.loli.net/2021/04/22/etCbVs329KxPuBm.png)小格子称为字段或域，数字表示字段的长度，单位是位(bit)，语法就是定义了这些小格子的长度和先后顺序。

![image-20210218094910389](https://i.loli.net/2021/04/23/aeOWw9BMmtP4uoD.png)

某个协议的语义规定收发双方要完成怎样的操作。

#### 服务

![image-20210218095205926](https://i.loli.net/2021/04/23/HacS3w6AEsz2F5e.png)

![image-20210218095318689](https://i.loli.net/2021/04/23/QBHq64dREabtZvn.png)

![image-20210218095500068](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210218095500068.png)

![image-20210218101252710](https://i.loli.net/2021/04/23/vhrOKqzeJGst2AM.png)

![计算机网络](https://i.loli.net/2021/04/23/MvUA2pK1iPhFajx.png)

## 题目

### OSI模型

![image-20210218105437123](https://i.loli.net/2021/04/23/Jf7t5cQa8qye6UW.png)

![image-20210218110104943](https://i.loli.net/2021/04/23/cHXgN8IqwsmL9T3.png)

![image-20210218110429400](https://i.loli.net/2021/04/23/gRKb7qlmWhfPeVY.png)

![image-20210218110557741](https://i.loli.net/2021/04/23/rsflcX56bJajPWg.png)

![image-20210218111101892](https://i.loli.net/2021/04/23/zkBUYsHqFfj7RAC.png)

![image-20210218141310191](https://i.loli.net/2021/04/23/RCvQZwGePL7jgqx.png)

![image-20210218141425320](https://i.loli.net/2021/04/23/H6IZeK9n5CWhFJi.png)

![image-20210218141804300](https://i.loli.net/2021/04/23/tYyoNMCG5ZbrgKv.png)

![image-20210218141909434](https://i.loli.net/2021/04/23/U1JKZtBb8mhEven.png)

![image-20210218142317511](https://i.loli.net/2021/04/23/9lDsVEdLXuAJTFh.png)

### 时延

![image-20210220092832765](https://i.loli.net/2021/04/23/wnMpsm2g7PlAQrc.png)

n个人跑步，每个人需要起步时间t0(s)，前一位起步完成后一位马上起步，路程s(m)，所有人速度相同为v(m/s)。

问所有人跑完的时间为？

解析：最终时间为第n个人到达时间，为第n个人开始跑的时间 + 第n个人跑完全程时间

$$ n * t_0 +  \frac sv$$

![image-20210220094921326](https://i.loli.net/2021/04/23/oN1HpdWxwUq6zKv.png)

![image-20210220100442828](https://i.loli.net/2021/04/23/kQvw8fGCY9D4P3B.png)

![image-20210220101104125](https://i.loli.net/2021/04/23/3jhm21es59JdZpN.png)

![image-20210220102800244](https://i.loli.net/2021/04/23/PJh4ZAvxiHcCebE.png)

![image-20210220103717826](https://i.loli.net/2021/04/24/kEjzdSDubFpw3PB.png)

# 物理层

## 传输媒体

### 导引型传输媒体

* 同轴电缆

* 双绞线
  * 无屏蔽
  * 有屏蔽

  > 绞合的作用：抵御部分来自外界的电磁波干扰，减少相邻导线的电磁干扰
  
* 光纤
  * 多模
  * 单模：直径等于波长

* 电力线

### 非导引型传输媒体

* 无线电波

* 微波

* 红外线

* 可见光

## 传输方式

### 串行与并行

> 串行一条传输线路，并行多条线路

### 同步与异步

> 同步字节间没有间隔，时钟要同步，
>
> ​	外同步：添加单独的时钟信号线
>
> ​	内同步：发送端将时钟同步信号编码到发送数据中一起传输（曼彻斯特编码）
>
> 异步字节间时间间隔不固定，每一位的间隔是相同的

### 单工、半双工、双工

> 单工：单向，只需要一条信道
>
> 半双工：双向不同时
>
> 双工：双向同时

## 编码与调制

![image-20210310200644306](https://i.loli.net/2021/04/24/g41rajwifB5ue7v.png)

> ==将数字信号或模拟信号转化为数字信号的叫编码，将数字信号或模拟信号转化为模拟信号的叫调制。==

**码元**：在使用时间域的波形表示数字信号时，代表不同离散数值的基本波形。也就是构成信号的一段波形。

### 常用编码

#### 不归零编码

![image-20210310201308053](https://i.loli.net/2021/04/24/AaJLrGb2vKi1ng3.png)

#### 归零编码

![image-20210310201402484](https://i.loli.net/2021/04/24/mXarMJT4es1dliu.png)

#### 曼彻斯特编码与差分曼彻斯特编码

![image-20210310201658921](https://i.loli.net/2021/04/24/GJukRH7L4I56U1s.png)

![image-20210310202512495](https://i.loli.net/2021/04/24/OoTsHM6i1JNLhyY.png)

### 调制方法

#### 基本调制方法

![image-20210311092240196](https://i.loli.net/2021/04/24/lZH6XesNWxhbfpM.png)

![image-20210311092130336](https://i.loli.net/2021/04/24/KndEzQ9DHfTSNy6.png)

从此图中可以看出，这个初相是180°。

#### 混合调制

![image-20210311093021346](https://i.loli.net/2021/04/24/hwR6U3ruIZfNYQF.png)

$$x = Acos(wt + Φ)$$

频率 = $$\frac {2Π}{|w|}$$

相位 = $$ wt + Φ$$

![image-20210311093320366](https://i.loli.net/2021/04/24/cVL1Hz2vlsw9PSb.png)

![image-20210311093457183](https://i.loli.net/2021/04/24/Qk6LxVCezOWGgYZ.png)

16种码元可以用4bit表示。

**格雷码：每两个码元间只能有一个bit位不同。**

![image-20210311093633840](https://i.loli.net/2021/04/24/EBPeKWb1Xpjos9D.png)

## 信道极限容量

数字信号在质量差的信道进行传输时会 产生失真。

![image-20210311095254114](https://i.loli.net/2021/04/24/4c7mSLtwyhiAq63.png)

### 奈氏准则

==**主要描述的是码元传输速率**==

![image-20210311095605939](https://i.loli.net/2021/04/24/aSXMj7hyFWHoBJ8.png)

比特率与波特率（码元传输速率）并不相同。波特率是以码元为基本要素的，而比特率却是以比特为基本要素。如果一个码元可以携带n个比特。那比特率就是波特率的n倍。

> 上面介绍基本调制，是二元调制，只能产生两种不同的码元，也就是两种不同的基本波形。每个码元只能携带1bit的信息量。而混合调制属于多元调制，每个码元可以携带4bit的信息量。

### 香农公式

![image-20210311100310780](https://i.loli.net/2021/04/24/HRakT8ZLz64Kmcu.png)

![image-20210311100341853](https://i.loli.net/2021/04/24/9fvl3jxTLNM6qnm.png)

![image-20210311100834499](https://i.loli.net/2021/04/24/j1Zsypa4uedPToz.png)

![image-20210311101231571](https://i.loli.net/2021/04/24/i4WwzR3Jk9DUGE1.png)

![image-20210311101634945](https://i.loli.net/2021/04/24/VLJgHBGXfzs2bvk.png)

 ![image-20210311102342092](https://i.loli.net/2021/04/24/yuMthldAqVBjXpS.png)

 

![](https://i.loli.net/2021/04/24/Rl1WgahTydrxU5E.png)

![image-20210312095858913](https://i.loli.net/2021/04/24/BDTbqrmojX2h5sU.png)

![image-20210312102741793](https://i.loli.net/2021/04/24/DsQE3LFcGmvb4il.png)

# 数据链路层

##　概述

![image-20210312104835728](https://i.loli.net/2021/04/24/g3lp8A4MNHkZJtX.png)

在研究数据链路层上的问题时，大多数情况下，我们只关心数据链路层的问题，而不需要考虑其它各层，这是计算机网络分层思想的一个重要原因。

这里的**链路**是一个抽象概念，从图中来看，其为数据链路层间的一条传输线。

而**数据链路**就是加上了软件和硬件后构成的。

数据链路层与物理层不同，其以帧为基本单位传输和处理数据。帧肯定是比比特更大的一个单位。这也是一层抽象。

### 数据链路层的三个重要问题

#### 封装成帧

![image-20210312110018417](https://i.loli.net/2021/04/24/Q5bz6OBnXDyYfIg.png)

* **封装成帧**：数据链路层给上层交付的协议数据单元添加帧头和帧尾，使之成为帧。
  * 帧头和帧尾中包含有重要的控制信息
  * 帧头和帧尾的作用之一就是**帧定界**

PPP帧

![image-20210312110757613](https://i.loli.net/2021/04/24/baHp1O4R8wEFKtP.png)

MAC帧

![image-20210312111438657](https://i.loli.net/2021/04/24/1zAR5PxyJToeHuI.png)

![image-20210312111523583](https://i.loli.net/2021/04/24/yPl3bq5KeaQx7R8.png)

* **透明传输**：数据链路层对上层交付的传输数据没有任何限制，就好像数据链路层不存在。
  * 面向字节的物理链路使用字节填充（或称为字符填充）的方法实现透明传输。

![image-20210312111839537](https://i.loli.net/2021/04/26/KthQxnf2y1eUcOV.png)

* 面向比特的链路使用比特填充的方法实现透明传输。

![image-20210312171815354](https://i.loli.net/2021/04/26/Uh7mK89rl4MFPXZ.png)

![image-20210312171901105](https://i.loli.net/2021/04/26/sQuWE3VUIgAlndK.png)

![image-20210312172001169](https://i.loli.net/2021/04/26/gH6QT4bNlSE5emL.png)

#### 差错检测

* 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错，这称为**比特差错**
* 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER(Bit Error Rate)
* 使用**差错检测码**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一

![image-20210312110139542](https://i.loli.net/2021/04/26/MXLGiJF6Sbogv3I.png)

![image-20210312110155648](https://i.loli.net/2021/04/26/XjD6Yb9El8MI1vt.png)

1. 奇偶校验

> 在待发送的数据后面添加1位奇偶校验位，使整个数据（包括所添加的校验位在内）中“1”的个数为奇数（奇校验）或偶数（偶校验）。
>
> 简单来说，就是加一位数据后，整个数据“1”的个数是奇就是奇校验，是偶就是偶校验。

![image-20210312183239362](https://i.loli.net/2021/04/26/9kqyRvjKFB4uU61.png)

可以看出，如有奇数个位发生了误码其是可能检测出误码的。因为只有两种数据可能，要么是0，要么是1。反过来，如有偶数个位发生了误码，是无法检测出误码的。这就是**漏检**。

奇/偶 + 2 = 奇/偶

2. 循环冗余检验CRC（Cyclic Redundancy Check)

* 收发双方约定好一个生成多项式G(x)
* 计算冗余码，添加到待传输数据后面
* 接收方检验是否有误码

![image-20210312183852867](https://i.loli.net/2021/04/26/DtYiOPU5lq4KLgx.png)

![image-20210312183944634](https://i.loli.net/2021/04/26/eAjV9B1uLsYkFNg.png)

异或进行运算。

![image-20210312184031845](https://i.loli.net/2021/04/26/uigVLI2czlH4ryt.png)

![image-20210312184053177](https://i.loli.net/2021/04/26/5i48yBmIVNFvhCD.png)

![image-20210312184523793](https://i.loli.net/2021/04/26/NA7R6aBWSzwebIO.png)

#### 可靠传输实现机制

![image-20210312110246805](https://i.loli.net/2021/04/27/x9hVgQKnadEieNF.png)

* 如果发生了误码，根据数据链路层向上层提供的服务类型做以下相应的操作：
  * 不可靠传输：仅仅丢弃有误码的帧，其他什么也不做
  * 可靠传输：想办实现发送端发送什么 ，接收端就收到什么

* 一般情况下，有线链路的误码率软低，为了减小开销，不要求数据链路层向上提供可靠传输服务。即使出现了误码，可靠传输的问题由其上层处理。
* 反之，对于无线链路，易受到干扰，就要求数据链路层必须向上层提供可靠传输服务。

* 比特差错只是传输差错中的一种，传输差错还包括分组丢失、分组失序及分组重复。而这三种传输差错一般不会出现在数据链路层，而会出现在其上层。
* **可靠传输服务并不局限于数据链路层，其他各层均可选择实现可靠传输**

![image-20210312192746093](https://i.loli.net/2021/04/27/IaMAPkQ4GF6mtYc.png)

> 可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用需求。

==以下三种可靠传输实现机制的基本原理并不仅限于数据链路层，可以应用到计算机网络体系结构的各层协议中==

1. 停止-等待协议SW(Stop-and-Wait)

如下图所示，发送方与接收方基于互联网通信，而不是基于某一条点对的链路。

> 发送方发送数据分组接收方对其进行差错检测，
>
> * 如果没有产生误码则接受此分组并给发送方发送确认分组，简称ACK。
> * 如果有误码，则丢弃该分组，并给发送方发送否认分组，简称NAK。发送方收到否认分组后，立即重传。
>
> 所以，发送方在发送完并不能立即从缓存中删发送的分组，只有等收到确认分组后才能从其缓存中删除。
>

![image-20210313111347235](https://i.loli.net/2021/04/27/yXUlTg89Lw5ICO7.png)

* 如果发送方发送的分组在传输过程丢失怎么办？

![image-20210313155422467](https://i.loli.net/2021/04/27/w9vF5qzZlBOrEck.png)

* 如果接收方发送的确认分组或者否认分组丢失怎么办？

![image-20210313155547029](https://i.loli.net/2021/04/27/yzADuZEKcBbFdwM.png)

发送方没有收到确认就会重传，那接收方会再接收一次，怎么办？

> 因为发送的新分组与前一个分组是不一样的，可能用1bit来表达这两个序号。如果接收方又接收到了相同序号的分组，那就表明其返回的确认分组丢失了。其要做的是丢序这个分组，再返回一个确认分组。

![image-20210313160101002](https://i.loli.net/2021/04/27/9KneV1mrGOItA3F.png)

* 发送分组要序号，那么接收方返回的分组要不要确认呢？

![image-20210313160253282](https://i.loli.net/2021/04/27/xHRsUgIq2ki48Zo.png)

> 看这个图，如果第一次的确认分组超过时间，发送方重传后又收到了确认分组，遂即发送第2个分组。在此之前，接收方丢弃第一个重传的分组，返回一个确认分组。那么发送方怎么知道这个确认分组其不是第2个发送分组的呢？所以我们也要对确认分组进行编号。

![image-20210313160817920](https://i.loli.net/2021/04/27/PiYZSedfvCMOWN2.png)

==对于数据链路层，点对点通信，时间比较固定，一般不会出现，确认迟到的情况。所以，一般不用给确认分组编号。==

![image-20210313161209555](https://i.loli.net/2021/04/27/rMcoQBkt7KvHO5C.png)

**信道利用率**

![image-20210313161425244](https://i.loli.net/2021/04/27/qw1HfGFR8DzcavB.png)

![image-20210313161602300](https://i.loli.net/2021/04/27/6DeEqAz1MuYUf9x.png)

>*这种类型的协议常被称为自动请求重传ARQ(Automatic Repeat reQuest)协议。*

2. 回退N帧协议GBN(Go-Back-N)

为了解决停止-等待协议的信道利用率低的问题。将一次发送一个等待确认，改为了一次发送多个再确认。像流水线一样。

![image-20210313201326136](https://i.loli.net/2021/04/27/ompT8rGdn41RULY.png)

* 采用3个比特给分组编序号，即序号0-7
* 发送窗口的尺寸$$W_T$$的取值：$$1 < W_T < 2^3 - 1$$

如果为1那就是停止-等待协议。

![image-20210313201924908](https://i.loli.net/2021/04/27/t52QSMVox1sadCZ.png)

**无差错的情况下**

发送方一次发送多个，接收方每接收到一个其窗口就向后滑动一个，并且发送确认分组，同理，当发送方每接收到一个确认分组后，就将窗口向后移动一个位置，然后删除缓存中的分组。

![image-20210313202312690](https://i.loli.net/2021/04/27/k3NTrgqlUjYLfdR.png)

**累积确认**

> 接收方不一定要对收到的数据分组逐个发送确认，而是可以在收到几个数据分组后（由具体实现决定），对按序到达的最后个数据分组发送确认。ACKn表示序号为n及以前的所有数据分组都已正确接收。

例如：如果发送窗口发送了5个数据分组，收到接收返回的ACK4确认，就表示全部收到。==这里是序号n是从0开始的==。

![image-20210313202914410](https://i.loli.net/2021/05/02/zanM6d2ZEJohABf.png)

累积确认的优点是：如果确认分组丢失， 发送方也有**可能**不必重传。而且而减少了资源。

**有差错的情况下**

如下图所示，如果5序号的分组丢失。

![image-20210313203133539](https://i.loli.net/2021/05/02/LflyX2iUHxcaZAw.png)

因为序号不匹配，所以接收方全部不接收，全部丢弃。

![image-20210313203152260](https://i.loli.net/2021/05/02/ScH5J4GiQsKh8kM.png)

同时每丢弃一个分组，就对最后一个接收到的分组进行确认，在本例中是ACK4，返回给发送方。发送了4个ACK4。

![image-20210313203343149](https://i.loli.net/2021/05/02/DdJX25hMicE3lvk.png)

发送方收到重复的确认，就可能会重传。（视情况而定）

![image-20210313203506393](https://i.loli.net/2021/05/02/NMJh7zKplofLA1j.png)

![image-20210313203650397](https://i.loli.net/2021/05/02/xUnJCYbB4pmKjt9.png)

如果$$w_T$$= 8，确认后ACK7丢失，发送方要重发，重发到达后，接收方无法通过序号知道这些数据分组是重发的。

如果$$W_T > 8$$，比如10一次正确接收后返回一个ACK1，那发送方会认为只有序号1之前的正确接收了，1之后的会再次重传一遍，也是会导致上面的情况。

![image-20210313204242594](https://i.loli.net/2021/05/02/EVrU4WPHnMTGNgw.png)

![image-20210313205420723](https://i.loli.net/2021/05/02/a62kz4gUQ5qSKbs.png)

![image-20210313205446780](https://i.loli.net/2021/05/02/9LsNMSAUZPWf32z.png)

> *回退N帧协议是一种连续ARQ协议。又称为滑动窗口协议。*

==通信线路质理不好时，其信道利用率并不比停止-等待协议高==

3. 选择重传协议SR(Selective Request)

> 对于回退n帧协议，发送分组只要有一个丢失，就会导到致整个分组被接收方全部丢弃，然后全部重传。有没有一种协议可以只重传丢失的数据。选择重传协议就是为了解决这个问题。

> 这样一来，接收窗口尺寸就必然不能只是一个，要不然怎么收到那些重传过来的丢失分组。也就是要按照失序序号进行填充。将收齐的一并送交上层。

==为了能找到丢失的分组，接收方必然要确认每个到达的分组，以确定哪一个序号的分组已经丢失，而不能再使用累积确认。==

用3bit来放序号

$$1 < W_T <= 2^{3-1}$$这里取4，应该只用2bit来保存序号。



![image-20210314132321109](https://i.loli.net/2021/05/02/n8b5uvTSxFXEPrW.png)

现发送4个数据分组。

![image-20210314132602001](https://i.loli.net/2021/05/02/QN6e3iMfuOpacWq.png)

其中序号为2的分组丢失。

![image-20210314132617291](https://i.loli.net/2021/05/02/McripRSogkFdAlQ.png)

接收窗口收到0、1后后移，2没有收到就不动，后面收到也不动，收到3。

![image-20210314132631801](https://i.loli.net/2021/05/02/8nmjaFONTXYJsIQ.png)

返回0、1、3的确认为分组。

![image-20210314132648018](https://i.loli.net/2021/05/02/1bHAvKLUxpG6yrS.png)

发送窗口收到1、2的确认分组，窗口后移两位，直接发送4、5。2没收到不移动。

![image-20210314132725870](https://i.loli.net/2021/05/02/pJcLREjKfgrC2se.png)

收到3做记录，以免后面超时重传。

![image-20210314132733248](https://i.loli.net/2021/05/02/K1yrbQUYvtA9Gca.png)

4、5到达接收窗口，返回确认。

![image-20210314132833766](https://i.loli.net/2021/05/02/QJjE7HnAKZ4OBdl.png)

4、5确认记录。2超时重传，返回确认，接收窗口后移4位。

![image-20210314132905497](https://i.loli.net/2021/05/02/kCiEP9AmlOGVXST.png)

收到确认，发送窗口后移4位。

如果$$W_T > 2^{n-1}$$，令其为5。

![image-20210314134234045](https://i.loli.net/2021/05/02/aZJm6dXsBVjLFKx.png)

在返回确认时0序号丢失，接收却又有0，所以会造成接收方无法分辨新、旧数据分组的问题。

==原理是保证窗口整个向后挪一次不会出现相同序号，以免丢失这个序号的ACK重发时分辨不出新旧==，$$2^n / 2$$就可以满足。

![image-20210314134642258](https://i.loli.net/2021/05/03/4sudGlhFS5AWPIv.png)

![image-20210314134657689](https://i.loli.net/2021/05/03/Bm12UfTzvJpDVH8.png)

![image-20210314134720876](https://i.loli.net/2021/05/03/axEvU8btQJ94LBK.png)

## 点对点协议 PPP(Pointt-toPoint Protocol)

> 点对点协议是目前使用最广泛的点对点数据链路层协议

![image-20210315095035101](https://i.loli.net/2021/05/03/hEZHcY78FKUProW.png)

> PPP协议时因特网工程任务组IETF在1992年制定的。经过1993年和1994年的修订，现在的PPP协议 已成为因特网的正式标准[RFC1661, RFC1662]

* PPP协议为在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三部分构成。
  * 对各种协议数据报的封装方法(封装成帧)
  * 链路控制协议LCP(用于建立、配置以及测试数据链路的连接)
  * 一套网络控制协议NCPs(其中的每一个协议支持不同的网络层协议)

![image-20210315095639416](https://i.loli.net/2021/05/03/k63MeGPSjLW7adD.png)

### 帧格式

![image-20210315095831841](https://i.loli.net/2021/05/03/zPfxBlXJAYZ8St2.png)

- 不依赖上层链路控制协议 LCP (Link Control Protocol)。
- 依赖上层网络控制协议 NCP (Network Control Protocol)。如果此时上层为IP，NCP也叫做IPCP(IP Control Protocol)。

### 解决透明传输问题

![image-20210315100121783](https://i.loli.net/2021/05/03/4NXvZGVcntqgura.png)

#### 字节填充法

![image-20210315100316363](https://i.loli.net/2021/05/03/UoipRFdDK4tQxYE.png)

控制字符是不可打印字符。可打印的字符是**可以从键盘上输入的字符**，出现ASCII控制字符，需要加入转移字符，并对相应的控制字符做出改变。

> 第0～32号及第127号(共34个)是控制字符或通讯专用字符。如控制符：LF（换行）、CR（回车）、FF（换页）、DEL（删除）、BS（退格)等通讯专用字符：SOH（文头）、EOT（文尾）、ACK（确认）等

#### 比特填充法

![image-20210315100443680](https://i.loli.net/2021/05/03/h6q8l9wTUxrNFPM.png)

#### 差错检测

![image-20210315102049228](https://i.loli.net/2021/05/03/hfoVtYqyXMvNmdS.png)

#### 工作状态

![image-20210315102251725](https://i.loli.net/2021/05/03/RSdwIPBYKX4DTef.png)

## 媒体接入控制 

> 共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**(Medium Access Control)。

![image-20210315103244558](https://i.loli.net/2021/05/03/ZHSlvchOGf1T7PU.png)

![image-20210315103327286](https://i.loli.net/2021/05/03/hJ2LHnGTiQKzyu8.png)

### 静态划分信道

#### 信道复用

![image-20210316200449738](https://i.loli.net/2021/05/03/dmBRuqL68tGFbcf.png)

##### 频分复用FDM

![image-20210316201547792](https://i.loli.net/2021/05/03/Na1fjhpVrMsIJny.png)

将传输线路的频带资源划分成多了子频带，形成多个子信道。隔离频带是避免干扰的。

**复用器**：将每一路信号调制到不同频率的载波上。合成信号。

**分用器**：通过滤波将各路信号分开。恢复信号。

##### 时分复用TDM

![image-20210316202026410](https://i.loli.net/2021/05/03/lGE9jXiBRPqKOwk.png)

##### 波分复用WDM

就是对光的频分复用：

![image-20210316202156839](https://i.loli.net/2021/05/03/dwvpyLEc5XFrV1A.png)

可以放入4个放大器，使得光复用器和光分用器之间的无光电转换的距离可达600km。

##### 码分复用CDM

该技术主要用于多址接入，人们更常用的名词是码分多址CDMA（Code Division Multiple Access）

![image-20210316202604351](https://i.loli.net/2021/05/03/xN1ovr83FCHOlTy.png)

![image-20210316202723758](https://i.loli.net/2021/05/03/eWZlBh18HnEksSd.png)

![image-20210316203328259](https://i.loli.net/2021/05/03/gbYauwT8HRpv4XL.png)

每一个比特时间，也就是一个站点，它有m个码片(构成了一个码片序表)，这个码片序列是唯一的。如果发送1 ，就发送这个序列，如果发送0，就发送这个序列的反码。

将码片序列中的0写为-1，1写为+1。

* 码片序列挑选原则

  * 分配给每个站的码片序列必须各不相同，实际采用伪随机码序列。

  * ==分配给每个站的码片序列必须正交(规格化内积为0)==**这是规定**

    ![image-20210316203834427](https://i.loli.net/2021/05/03/oHA27QS8CUjxvRZ.png)

$S*S = \frac 1m \sum_{i=1}^mS_i*S_i = \frac1m\sum_{i=1}^m{S_i}^2 = \frac 1m\sum_{i = 1}^m(\pm1)^2 = 1$

$S*\neg T = 0$

$S*\neg S = -1$

![image-20210316210910832](https://i.loli.net/2021/05/03/S8HB5i2Ql3UYqW1.png)

```
0  1  0  1  1  1  0  1

1  0  1  1  1  0  0  0

-1 -1 -1 1  1 -1  1  -1 = -2
```

相异为-1。相同为1。

<center> 应用证明 </center>

![image-20210316211525777](https://i.loli.net/2021/05/16/9lpjY1GLkyMNhts.png)

收到的码片序列是发送的码片序列的叠加信号。与各发送站的码片序列相乘。D知道其它站的码片序列。

* 如果是1，就是发送了比特1。

* 如果是-1，就是发送了比特0。

* 如果是0，就是没有发送。

==可以用这种方法来判断出谁发了什么样的信号==

![image-20210316211730617](https://i.loli.net/2021/05/16/yUlR8IkmbLjXtof.png)

![image-20210316211803622](https://i.loli.net/2021/05/16/nA91UYXevNTSDy4.png)

![image-20210316211815819](https://i.loli.net/2021/05/16/rv3sydOL8NB9wSI.png)

![image-20210316211841442](https://i.loli.net/2021/05/16/fxh5Xnuci7RGbke.png)

![image-20210316212136109](https://i.loli.net/2021/05/16/gq97KLcb3vIMNDP.png)

由上述条件验证，如果发送1就是发自己的比特序列，如果是发送0，就是发送其反码。A站的比特序列是(1,1,1,1)，反码是(0,0,0,0)，也就是(-1,-1,-1,-1)。与

==弄清楚收到的信号的站收到的是发送的叠加信号，可以用这个叠加信号与其它发送信号相乘，就知道它是发送了什么信号，还是没有发送。==

## 随机接入(总线局域网使用的协议：CSMA/CD)

> 早期的以太网采用载波监听多址接入/碰撞检测CSMA/C	D (carrier Sense Multiple Access/Collision Detection)

![image-20210317090835406](https://i.loli.net/2021/05/16/QGonvCSuPc7rpzU.png)

### 多址接入MA

![image-20210317091008489](https://i.loli.net/2021/05/16/L96j5sUPrGZbidN.png)

### 载波监听CS

![image-20210317091015557](https://i.loli.net/2021/05/16/B6DyOqaPtwcUe4H.png)

### 碰撞检测CD

![image-20210317091022605](https://i.loli.net/2021/05/16/ckTwPUez4sGKhvE.png)

<font color = #F0000F size = 5 face = "宋体"> **举例：** </font>

![image-20210317091551421](https://i.loli.net/2021/05/16/ocRsUPJXgAiI29n.png)

多个主机接入一条总线上，如果主机C要发送帧，其先进行载波监听。发现总线有96比特的时间空闲后，就开始发送帧。如果此时主机B有帧要发送，主机B进行载波监听。信道空间96比特时间就发送帧，同时要检测碰撞，如果此时，主机C也载波监听无误后进行发送。就会与B所发送的信号碰撞。主机C更早的检测到碰撞，首先停止发送退避一段时间。

![image-20210317091941889](https://i.loli.net/2021/05/16/dCRH9Y8p65vtn3Z.png)

然后主机B也会检测到碰撞信号。

![image-20210317092232079](https://i.loli.net/2021/05/16/4Q1GcLbMFr7Cpan.png)

![image-20210317092243680](https://i.loli.net/2021/05/16/OumyJnIjL6Rt3Xv.png)

#### 争用期(碰撞窗口)

![image-20210317092556295](https://i.loli.net/2021/05/16/b642f5QugazxyqT.png)

> 主机A的碰撞往返时间为2$\tau$ - $\delta$，那么D的碰撞往返时间为$\delta$。有了D就少跑了$\delta$。右边的D的时间轴是假设情况。

主机往返时间

$$
2\tau - \delta
$$

* <font color = red size = 3>**主机最多经过2$\tau$($\delta -> 0$)的时长就可检测到本次发送是否遭受了碰撞。**</font>

* 因此，以太网的端到端往返传播时延2$\tau$称为争用期或碰撞窗口。

* 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

* 每一个主机在自己发送帧之后的一小段时间内，存在着遭遇碰撞的可能性。这一小段时间是不确定的。它取决于另一个发送帧的主机到本主机的距离，但不会超过总线的端到端往返传播时延，即一个争用期时间。

* 在以太网中发送帧的主机越多(距离越长)，端到端往返传播时延越大，发生碰撞的概率就越大。<font color = red>因此，共享式以太网不能连接太多的主机，使用的总线也不能太长。</font>

  ![image-20210317100021452](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210317100021452.png)

$$
\frac {512bit} {10 * 10^6bit/s} = 51.2\mu s
$$



<center><font color = blue>争用期是时间单位，就是往返时间</font>

$$
MAX_{争用期} = \frac d v *2​
$$

#### 最小帧长

![image-20210317101825067](https://i.loli.net/2021/05/16/Gj4gH8ZWMsKNwn2.png)

主机A向D发送一个帧长很小的帧，那么发送完此帧还没传输到位置D。但是主机A已经不会碰撞检测了。此时A发送出去的帧与C发送的帧发生了碰撞，最后到达了D，由于其不完整。必然会被主机D丢弃，而A又不会重传。就丢失了该帧。

* 以太网规定最小帧长为64字节(512bit)，此就是争用期，<font color = red>保证传输到底都有碰撞检测</font>。
  * 不够可以加入填充字节
* 以太网最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞。
  * 如果在争用期没有检测到碰撞，那后面发送的数据就一定不会发生碰撞 。
  * 如果在争用期内检测到碰撞，就立即中止发送，这时已经发送出去的数据一定小于64字节，因此，凡是长度小于64字节的都是由于碰而异常中止的无效帧。

#### 最大帧长

![image-20210317105003782](https://i.loli.net/2021/05/16/WIrSZxNwMyLJtpP.png)

##### 退避时间算法(截断二进制指数是数退避算法)

![image-20210317105301836](https://i.loli.net/2021/05/16/z9QEiVGDucJxwZT.png)

##### 信道利用率

![image-20210317105336039](https://i.loli.net/2021/05/16/LWR9ejw2JrvszhG.png)

##### 发送与接收流程图

![image-20210317105415412](https://i.loli.net/2021/05/16/Z9vWQboyq6DedLs.png)

![image-20210317105459974](https://i.loli.net/2021/05/17/4SuBFUZWzn3djp2.png)

##### 习题

![image-20210317105546666](https://i.loli.net/2021/05/17/4VWjNAe6riLBcXx.png)

 ![image-20210317110819870](https://i.loli.net/2021/05/17/IscRDYlvaTOHUkB.png)

![image-20210317111301177](https://i.loli.net/2021/05/17/Kcr4i8sC1dw53Aj.png)

什么时候时间最短，两者都在用信道的时候。<font color = red> **同时发送，中间碰撞，同时返回，这只用消耗一半的时间**</font>

![image-20210317111316176](https://i.loli.net/2021/05/17/SLQseZbA1Bc6wyx.png)

什么时候时间最长，两者中有一个跑了个来回。也就是争用期。

## 随机接入(无线局域网使用的协议：CSMA/CA)

### 基本内容

> 载波监听多址接入/碰撞避免(Carrier Sense Multiple Access/Collision Avoidance)
>
> 在无线局域网中无法进行碰撞检测。

![image-20210318092958358](https://i.loli.net/2021/05/17/Wm6n2Ihu4RSPsqX.png)

![image-20210318093151947](https://i.loli.net/2021/05/17/W4Xw23dPBJmIMou.png)

* 802.11无线局域网使用CSMA/CA协议，在CSMA的基础上增加了一个碰撞避免CA功能，而不再实现碰撞检测功能。
* 不可能避免所有碰撞，且无线误码率较好，80.11标准还使用了数据链路层确认机制(停止-等待协议)来保证数据被正确接收。
* 802.11的MAC层标准定义了两种不同的媒体接入控制方式：
  * 分布式协调功能DCF(Distributed Coordination Function)在DCF默认方式下，没有中心控制站点，每个站点使用CSMA/CA协议通过急用信道来获取发送权。
  * 点协调功能PCF(Point Coordination Function)。PCF方式使用集中按制接入算法(一般在接入点AP实现集中控制)，是802.11定义的可选方式，在实际中较少使用。

* 802.11标准规定，<font color = blue>所有站点必须在持续检测到信道空闲一段指定的时间后才能发送帧。这段时间称为帧间间隔(IFS)(InterFrame Space)</font>

* 帧间间隔的长短并不是一样的，取决于站点要发送帧的类型

  * 高优先级帧需要等待的时间较短，因此，可以先发送
  * 低先先组帧则较长。有时低优先级在等了一段时间后，高优先级才开始等，有可能此高优先级更快等完发送。低优先级就只能再推迟发送了。

* 常用的两种帧间间隔

  ![image-20210318095758349](https://i.loli.net/2021/05/17/yWxVfk97ldiBqHA.png)

### 应用

![image-20210318100254618](https://i.loli.net/2021/05/17/8UnC3IRVfN7Scpm.png)

![image-20210318100323685](https://i.loli.net/2021/05/17/Eu6QF8m35f4pZxH.png)

![image-20210318100416837](https://i.loli.net/2021/05/17/FW41Gw5gvmczTDQ.png)

* 当站点检测到信道是空闲的，并且所发送的数据帧不是成功发送完上一个数据帧之后产即连续发送的数据帧，则不使用退避算法。
* 下列情况必须使用退避算法：
  * 在发送数据帧之前检测到信道处于忙状态时
  * 在每一次重传一个数据帧时
  * 在每一次成功发送后要连续发送下一帧时(避免一个站点长时间占用信道)

#### 退避算法

![image-20210318101143897](https://i.loli.net/2021/05/17/xnIXFzBUQSZcsro.png)

#### 举例

![image-20210318102339577](https://i.loli.net/2021/05/17/cVKIfbwT8QAnzC6.png)

A、B、C、D、E是5个无线站点。

刚开始A在占用无线信道发送帧，B、C、D也要发送帧(图中向上的箭头)。

BCD进行载波监听，发现信道忙，需要退避。根据退避算法，算出一个退避时间，并在每个时隙对信道进行一次检测。

当BCD检测到信道由忙转为空闲，经过DIFS时间后，退避计时器开始倒计时。

C的退避时间最短，C立即发送帧。

B、D检测到信道忙，就冻结剩下的退避时间。

如果C在发送时，E也要发送，进行载波监听后，发送信道忙需要退避。在检测到信道转为空闲且经过DIFS后，退避计时器来始倒计时，BD解冻。

D到时发送，BE冻结。

D发送完，信道转为空闲且经过DIFS后，BE解冻。

E到时发送，B冻结。

D发送完，信道转为空闲且经过DIFS后，B解冻。

B到时发送，如果发送完还要发送，发送完当前帧后，等DIFS再退避才能发送。

==要注意的时，每次发送完都要经过DIFS才能继续操作。而且退避和解冻要在DIFS之后，因为其有可能要比发送帧的时间还短。==

#### CSMA/CA协议的信道 预约和虚拟载波监听

* 为了尽可能的<font color = red>减少碰撞的概率</font>和降低碰撞的影响，802.11标准允许要发送的数据的站点对信道进行预约。

![image-20210318165442349](https://i.loli.net/2021/05/17/pk8mNj64lBaJi79.png)



![image-20210318165609925](https://i.loli.net/2021/05/17/27PDN9OM54Cn3fs.png)

#### 虚拟载波监听

![image-20210318170359237](https://i.loli.net/2021/05/17/MaCPOvxiHQn9zD4.png)

A发送RTS给B，但是不能发送给C，所以C并不知道B将要被占用。而B可以发送CTS给C，因为CTS中带有时间，所以C就可能通过这个知道B将要被占用多少时间。

![image-20210318170600265](https://i.loli.net/2021/05/17/3XGw8eViU5umJSg.png)

在这段时间内，C都不会争用信道。

#### 习题

![image-20210319170531036](https://i.loli.net/2021/05/17/e3SotDr6RqcAxZX.png)

![image-20210319170655662](https://i.loli.net/2021/05/17/6IwyLajGbJnWRvH.png)

![image-20210319171015477](https://i.loli.net/2021/05/17/AGmBMnvKoOfVw1D.png)

## MAC地址

* 数据链路层
  * MAC地址是以太网的MAC子层所使用的地址;
* 网际层
  * IP地址是TCP/IP体系结构网际层所使用的地址；
  * ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址；

> 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址。

> 在每个主机发送的帧中<font color = blue>必须携带标识发送主机和接收主机的地址。</font>这类地址是用于媒体接入控制MAC(Media Access Control)，因此这类地址被称为MAC地址。

![image-20210406202202649](https://i.loli.net/2021/05/22/Evz7HhXxkog6leq.png)

**MAC地址一般被固化在网卡(网络适配器)的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为硬件地址。**

![image-20210406202445047](https://i.loli.net/2021/05/22/5rtMygh1V42dvJD.png)

MAC地址有时也被称为<font color = blue>物理地址</font>。(在windows系统中)，<font color = red>但是要注意：MAC地址并不属于物理层。</font>其属于数据链路层。

![image-20210406202811289](https://i.loli.net/2021/05/22/LN6tdPy1cRCx9wQ.png)

> 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器(有线网卡)和无线局域网适配器(无线网卡)。每一个网络适配器都有一个全球唯一的 MAC地址。
>
> 交换机和路由器往往拥有更多的网络接口，所以其会拥有 更多的MAC地址。
>
> **<font color = red> MAC地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识。</font>**

### IEEE 802局域网的MAC地址格式

![image-20210406203541552](https://i.loli.net/2021/05/22/1obsyTHNCiePYjG.png)

![image-20210406203957630](https://i.loli.net/2021/05/22/QXwItNijCKEZxLs.png)

第一字节的b1和b0位的特殊含意。

### IEEE 802局域网的MAC地址发送顺序

![image-20210407181340933](https://i.loli.net/2021/05/22/MVKLTSqC5BHjcAa.png)

字节发送顺序：第一字节->第六字节

字节内的比特发送顺序：$b_0->b_7$

### 单播MAC地址举例

![image-20210407181618145](https://i.loli.net/2021/05/22/P4YvrakQX1HKIZy.png)

B给C发送单播帧，在帧首部中的目的地址字段填入主机C的MAC地址。源地址字段填入自己的MAC地址。再加上帧首部中的其他字段、数据载荷及帧尾部。

![image-20210407181647618](https://i.loli.net/2021/05/22/K5xkNf1sULocTZQ.png)

![image-20210407181708022](https://i.loli.net/2021/05/22/tYnJzKR2f6XPhgr.png)

### 广播MAC地址举例

![image-20210407182844721](https://i.loli.net/2021/05/22/dKCns6avui9EJB5.png)

![image-20210407182931676](https://i.loli.net/2021/05/22/kXTV6WwOIHj3dAK.png)

### 多播MAC地址举例

![image-20210407195154007](https://i.loli.net/2021/05/22/FkMyxrGKUclzgo3.png)

第一个字节最低位为1(16进制是奇数)。

![image-20210407195258740](https://i.loli.net/2021/05/22/Ll7yDXUJYBkQS4j.png)

![image-20210407195338088](https://i.loli.net/2021/05/22/9CXLIbHqPArme8c.png)

<font color = blue>给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址，具体可在以下网址查询http://standards.ieee.org/develop/regauth/grpmac/public.html</font>

### 随机MAC地址

反监控

## IP地址

> IP地址属于网络层

* IP地址是因特网(Internet)上的主机和路由器所使用的地址，用于标识两部分信息：
  * 网络编号：标识因特网上数以百万计的网络
  * 主机编号：标识同一网络上不同主机(或路由器各接口)

![image-20210407202244919](https://i.loli.net/2021/05/22/A28RVef9sIECSOQ.png)

* MAC地址不具备区分不同网络的功能。
  * 如果只是一个单独的网络，不接入因特网，可以只使用MAC地址(这不是一般用户的应用方式)
  * 如果主机所在的网络要接入因特网，则IP地址和MAC地址都需要使用。

### 从网络体系结构看IP地址与MAC地址

![image-20210407202629808](https://i.loli.net/2021/05/22/jW1ZqUi9oKPmbOS.png)

### 数据包转发过程中IP地址与MAC地址的变化情况

![image-20210407202814886](https://i.loli.net/2021/05/22/8z34OoLQwRgehvS.png)

* <font color = blue>数据包转发过程中源IP地址和目的IP地址保持不变。</font>
* <font color = blue>数据包在转发过程中源MAC地址和目的MAC地址逐个链路(或逐个网络)改变。</font>

![image-20210407203106140](https://i.loli.net/2021/05/22/JAfbNYhEXuZ1SPd.png)

![image-20210407203128255](https://i.loli.net/2021/05/22/MdfCNpIruP6yAz3.png)

如何通过IP地址找到其相应的MAC地址？这是ARP协议要做的事。

![image-20210407203256919](https://i.loli.net/2021/05/22/z9xyBhIjAR5Z7ve.png)

## ARP协议

`Address Resolution Protocol`

![image-20210407211422739](https://i.loli.net/2021/05/22/yQ9H3KJT8cVfWkg.png)

 ![image-20210407212621027](https://i.loli.net/2021/05/22/S4tAUxG6hk9dpDQ.png)

![image-20210407212750632](https://i.loli.net/2021/05/22/srn1SNRFlMgP6QB.png)

ARP协议只能在一段链路或一个网络上使用。

## 集线器与交换机

### 集线器

* 早期的总线型以太网

<font color = orange>总线型以太网最初是用粗同轴电缆作为传输媒体，后来采用价格相对便宜的细同轴电缆。</font>

![image-20210410194216000](https://i.loli.net/2021/05/22/BhRNtiC6c5I9Oyq.png)

* 使用双绞线和集线器HUB的星型以太网

![image-20210410194428957](https://i.loli.net/2021/05/22/ueFtmZBbp3XrEqw.png)

> 使用集线器的以太网在逻辑上仍是一个总线网，各站共享总线资源，使用的还是CSMA/CD协议
>
> 集线器只工作在物理层，它的每个接口仅简单地转发比特，不进行碰撞检测（由各站网卡检测）
>
> 集线器一般都有少量的容错能力和网络管理功能。若网络中某个网卡出了故障，不停的发送帧。此时，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网仍然能正常工作。

* 使用集线器HUB在物理层扩展以太网

![image-20210410195103466](https://i.loli.net/2021/05/22/JdjAK6XZouL2pt7.png)

### 以太网交换机

> 以太网交换机通常有多个接口，每个接口都可以直接与一台主机或另一个以太网交换机相连。一般都工作为全双工方式。
>
> 以太网交换机具有并行性，能同时连通多对接口，使多对主机能同时通信，无碰撞(不使用CSMA/CD协议)。
>
> 以太网交换机一般都具有多种速率的接口，例如：10Mb/s、100Mb/s、1Gb/s、10Gb/s接口的多种组合。
>
> 以太网交换机工作在数据链路层(也包括物理层)，它收到帧后，在帧交换表中查找帧的目的MAC地址所对应的接口号，然后通过该接口转发帧。
>
> 以太网交换机是一种即插即用设备，其内部的帧交换表是通过自学习算法自动地逐渐建立起来的。
>
> 帧的两种转发方式：
>
> 1. 存储转发
> 2. 直通交换：采用基于硬件的交叉矩阵（交换时延非常小，但**不检查帧是否有差错**）

![image-20210410200031124](https://i.loli.net/2021/05/22/JFGEVwdgrlm9C1s.png)

![image-20210410201716706](https://i.loli.net/2021/05/22/1FwvdYkgsUzBZXP.png)

### 以太网交换机自学习和转发帧的流程

![image-20210410204220761](https://i.loli.net/2021/05/22/LX6RctMBwSxb95I.png)

![image-20210412194740710](https://i.loli.net/2021/05/22/BQZrfAItRHg73yD.png)

先登记再转发，如果转发的是已登记的就是明确转发，否则就是盲目转发。

![image-20210412195425905](https://i.loli.net/2021/05/22/Sby93ALIZUOmVQK.png)

![image-20210412195618491](https://i.loli.net/2021/05/22/xgNV5Ye1fjXAFc6.png)

![image-20210412195956554](https://i.loli.net/2021/05/22/cdlG7KTmUHxOqnu.png)

### 以太网交换机生成树协议STP

> 如果各网络之间只有一条链路，那么这条链路坏了就会影响整个网络的传播，可以使用添加冗余链路的方法提高以太网的可靠性。

但是冗余链路也会带来负面效应——形成网络环路

网络环路会带来以下问题：

* 广播风暴：大量消耗网络资源，使用网络无法正常转发其他数据帧
* 主机收到重复的广播帧：大量消耗主机资源
* 交换机的帧交换表震荡（漂移）

![image-20210412201729684](https://i.loli.net/2021/05/22/WrkwgB8NMd32Geu.png)

### 以太网交换机使用生成树协议STP(Spanning Tree Protocol)

<font color = blue>可以在增加冗余链路来提高网络可靠性的同时又避免网络环路带来的各种问题</font>

* 不论交换机之间采用怎样的物理连接，交换机都能够自动计算并构建一个逻辑上没有环路的网络，其逻辑拓扑结构必须是树型的(无逻辑环路)

* 最终生成的树型逻辑拓扑要确保连通整个网络

* 当首次连接交换机或网络物理拓扑发生变化时(有可能是人为改变或故障)，交换机都将进行生成树的重新计算

  ![image-20210412202438628](https://i.loli.net/2021/05/22/jH2mdNSuWq9eJVl.png)

## 虚拟局域网VLAN概述

![image-20210412204342833](https://i.loli.net/2021/05/22/PrMJUKayGji3T7w.png)

![image-20210412204402158](https://i.loli.net/2021/05/22/U165rgzidM7qpcC.png)

### 分割广播域的方法

* 使用路由器可以隔离广播域（成本高）

  ![image-20210412204524801](https://i.loli.net/2021/05/22/1CIqpb5Aeh6RgYS.png)

* 虚拟局域网VLAN技术

  > Virtual Local Area Network 是一种将局域网内设备划分成与物理位置无关的逻辑组的技术，这些逻辑组具有某些共同的需求。

![image-20210412204721870](https://i.loli.net/2021/05/22/RjnzobtfWEKxehB.png)

### 实现机制

#### IEEEE802.1Q帧

* IEEEE802.1Q帧（也称Dot One Q帧）对以太网的MAC帧格式进行了扩展，插入了4字节的VLAN标记

  ![image-20210412211428162](https://i.loli.net/2021/05/22/5mSx9l2ZqovePOL.png)

* VLAN标记的最后<font color = red>12比特</font>称为VLAN标识符VID，它唯一地标志了以太网帧属于哪一个VLAN
  * VID取值范围0\~4095(0\~2^12 - 1)
  * 0和4095都不用来表示VLAN，因此用于表示VLAN的<font color = red>VID的有效值取值范围是1~4094</font>
* <font color = red>802.1Q帧是由交换机来处理的，而不是用户主机来处理的</font>
  * 当交换机收到<font color = blue>普通的以太网帧</font>时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称“打标签“。
  * 当交换机<font color = blue>转发802.1Q帧</font>时，==可能==会删除其4字节VLAN标记转变为普通以太网帧，简称“去标签”。

#### 交换机的端口类型

* Access

  * Access端口一般用于连接用户计算机

  * Access端口只能属于一个VLAN

  * Access端口的PVID值与端口所属VLAN的ID相同（默认为1）

  * Access端口接收处理方法：

    * 只接受“未打标签”的普通以太网MAC帧。根据接收帧的端口的PVID给帧“打标签”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等。<font color = blue>(打标签：从哪里来的打哪里的)</font>

  * Access端口发送处理方法：

    * 若帧中的VID与端口的PVID相等，由“去标签”并转发该帧;否则不转发。这就起到了阻碍发送的作用。<font color = blue>(号码相同：给你去标签)</font>

    ![image-20210412213606793](https://i.loli.net/2021/06/17/HpSysjxhud7eva8.png)

    ![image-20210412213641117](https://i.loli.net/2021/06/17/v4x7ePIBZwO8NAc.png)

    ![image-20210412213702086](https://i.loli.net/2021/06/17/KhpF2gxkcUqw7mf.png)

* Trunk(树干)

  * Trunk端口一般用于交换机之间或交换机与路由器之间的互连
  * Trunk端口可以属于多个VLAN
  * 用户可以设置Trunk端口的PVID值。默认情况下，Trunk端口的PVID值为1。

![image-20210412214251791](https://i.loli.net/2021/06/17/zZBK62eamojHwqT.png)

交换机上电时默认配置各Access端口属于VLAN1，其相应的PVID值等于1。分别在两个交换机上创建VLAN2，将端口3，4划归到VLAN2，相应PVID值为2。

* Trunk端口发送处理方法：(<font color = blue> 接收与发送是相对于本端口而言，对于本例Trunk是在交换机1上发送数据到交换机2上的Trunk端口</font>)

  * 对VID等于PVID的帧，“去标签”再转发

  * 对VID不等于PVID的帧，直接转发

    ![image-20210412214505868](https://i.loli.net/2021/06/17/X35lxgHnqRYiyNQ.png)

* Trunk端口接收处理方法：

  * 接收“未打标签”的帧，根据接收帧的端口的PVID给帧“打标签”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等。

    ![image-20210412214743148](https://i.loli.net/2021/06/17/9GUrZvSjT8PONYg.png)
    
  * 接收“已打标签的帧”，不做任何操作

    ![image-20210412221452019](https://i.loli.net/2021/06/17/QcFiqCP1BzlYUrt.png)

<font color = red>连接主机的交换端口应设置为Access类型，各交换机之间互连的端口应设置为Trunk类型。</font>

![image-20210415085626416](https://i.loli.net/2021/06/17/PBMoOFe8rmEcu4z.png)

* Hybrid(杂种)

交换机各端口的缺省VLAN ID

> 思科交换机上称为Native VLAN，即本征VLAN。
>
> 在华为交换机上称为Port VLAN ID，即端口VLAN ID，简记为PVID。

* Hybrid端口既可以用于交换机之间或交换机与路由器之间的互连(Trunk)，也可用于交换机与用户计算机之间的互连。
* Hybrid端口可以属于多个VLAN
* 用户可以设置Hybrid端口的PVID值。默认情况下Hybrid端口的PVID值为1(同Trunk端口)



* **Hybrid发送处理方法，看帧的PVID值是否在其“去标签”列表中**
  * **存在，去标签转发**
  * **不存在，直接转发**
* **Hybrid发送处理方法(同Trunk)**
  * **未打标签，打上自己的标签**
  * **打了标签，不做任何操作** 

![image-20210415091804854](https://i.loli.net/2021/06/17/8gKLS9OiHQcVd7U.png)

# 网络层

## 概述

> 网络层的主要任务是实现网络互连，进而实现数据包在各网络之间的传输。

* 网络层向运输层提供怎样的服务？
* 网络层寻址问题
* 路由选择问题(怎么走)：根据路由表
  * 人工配置
  * 路由选择协议

![image-20210416210711934](https://i.loli.net/2021/04/29/Jc3n1ITC6gFOlBS.png)

## 网络层提供的两种服务

![image-20210416211520051](https://i.loli.net/2021/04/29/51Vg6nhdoIHzLjK.png)

## IPV4地址概述

![image-20210416213539432](https://i.loli.net/2021/04/29/jRZzty84QBF17Ns.png)

![image-20210416213557955](https://i.loli.net/2021/04/29/FMeQLaWU9n8Oq3A.png)

## 分类编址的IPv4地址

![image-20210417193051383](https://i.loli.net/2021/04/29/KSvQtDN1qwmURFO.png)

### A类地址

![image-20210417193138235](https://i.loli.net/2021/04/29/LHBdiYIVCRcx7y5.png)

网络号为全0的地址保留，后7位全为1的地址为本地环回测试地址。

> 主机号全0，网络地址
>
> 主机号全1，广播地址

### B类地址

![image-20210417193257976](https://i.loli.net/2021/04/29/oh2m7f3LDKcNqpw.png)

### C类地址

![image-20210417193440933](https://i.loli.net/2021/04/29/GrDzNP4foiMsE2h.png)

### 练习

![image-20210417193538312](https://i.loli.net/2021/04/29/cBtHQWz1wqZP46p.png)

![image-20210417193623358](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210417193623358.png)

![image-20210417193643143](https://i.loli.net/2021/04/29/1Jj2UvXcw6uoHYM.png)

![image-20210417193830603](https://i.loli.net/2021/04/29/haQgTwsmqLtHbzZ.png)

1. 主机与路由，路由与路由都算作是一个网络，交换机是数据链路层，不能单独作为一个网络。

2. 网络中每一台主机分配一个主机号，网络中的路由器接口也算一个，65534+1 = 65535，B类网络可以分配的主机数量为$2^{16} - 2 = 65534$ 个，所以只能用A类。

   两个路由器接口要分配两个IP地址

3. ==网络号不是主机号==

网络地址与广播地址都不能分配给主机或路由器接口，无法啐一标识一台主机或路由器的某个接口。

## 划分子网的IPv4地址

==新增网络时重申网络号会花费更多的成本==

![image-20210417204727641](https://i.loli.net/2021/04/29/G7WbgQPFmKdUI1v.png)

> 从IP地址的主机号部分借用一些位来作为子网号来区分不同的子网。 

![image-20210417204650825](https://i.loli.net/2021/04/29/WaGO3txbpKRlCmB.png)

但是人和计算机怎么知道有多少位比特被用作了子网号。

* <font color = red>**32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号**</font>
  * 用连续的比特1来对应网络号和子网号
  * 用连续的比特0来对应主机号
  * 将划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可得到IPv4地址所在子网的网络地址

![image-20210417205430128](https://i.loli.net/2021/04/29/AYMD7IFCWoEQ1iK.png)

### 举例

![image-20210417205518826](https://i.loli.net/2021/04/29/3BOjG1g5l4Fs9Ky.png)

一个比特用作子网号，两种可能。

![image-20210417205547292](https://i.loli.net/2021/04/29/DnuolHrKMkq1RIP.png)

![image-20210417205639105](https://i.loli.net/2021/04/29/N69uFXcBSfQj1kW.png)

可以看出多分出了几个子网，每多一个子网，就会多一个网络地址和广播地址，可分配的IP地址少了两个。

### 练习

![image-20210417210558704](https://i.loli.net/2021/04/29/gSuHkXVfNYEMAQ3.png)

通过掩码与IP地址找到子网号。其后全取1即是广播地址。

![image-20210417210702896](https://i.loli.net/2021/04/29/ojZsv3kqpNlu1Kh.png)

![image-20210417210643292](https://i.loli.net/2021/04/29/rqCmb61ELUkNFJR.png)

### 默认子网掩码：

> 在未划分子网的情况下使用的子网掩码

![image-20210417210845247](https://i.loli.net/2021/05/19/aKAElRztvZfnXU8.png)

## 无分类编址的IPv4地址

> 划分子网在一定程充上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网因为其地址空间太小并没有得到充分使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面临全部耗尽的威胁。

> 为此，因特网工程任务组IETF又提出了采用无分类编址的方法来解决IP地址紧张的问题，同时还专门成立IPv6工作组负责研究新版本IP以彻底解决IP地址耗尽问题。

> 1993年，IETF发布了无分类域间路由选择CIDR(Classless Inter-Domain Routing)的RFC文档：RFC 1517~1519和1520。

CIDR读作sider。

<font color = red>CIDR消除了传统的A类、B类和C类地址，以及划分子网的概念；</font>

<font color = red>CIDR可以更加有效地分配IPv4的地址空间，并且可以在新的IPv6使用之前允许因特网的规模继续增长</font>

![image-20210419094737932](https://i.loli.net/2021/05/19/WVHaNincMulLgqA.png)

思想是将相同的网络前缀IP组成一个CIDR地址块。

### 举例

![image-20210419095011094](https://i.loli.net/2021/05/19/zk3yKf7GCd8XvOI.png)

![image-20210419095109701](https://i.loli.net/2021/05/19/oCfGe39iDWArTKw.png)

### 路由聚合(构造超网)

如果多个网络与同一个路由器相连，这个路由器如何给网络信息给另外一个路由器。

![image-20210419095538454](https://i.loli.net/2021/05/19/gfTI6ZMODozKwPp.png)

如果把每一个都发过去，就会占用很大的空间，将它们聚合成一条。

![image-20210419095737803](https://i.loli.net/2021/05/19/mRFALIzlU9uGXfJ.png)

![image-20210419095802607](https://i.loli.net/2021/05/19/tJ86vKdzYgQThbk.png)

## IPv4地址的应用规划

![image-20210419104847772](https://i.loli.net/2021/05/19/OxV75T8BEbuskzt.png)

![image-20210419104929344](https://i.loli.net/2021/05/19/BTuVtMAgskbS9mK.png)

**应用需求：将C类网络218.75.230.0划分成5个子网，每个子网可分配的IP地址数量不得少于各自的需求。**

### 定长的子网掩码

![image-20210419105212382](https://i.loli.net/2021/05/19/2RGhTIDNMonXBEa.png)

![image-20210419105230493](https://i.loli.net/2021/05/19/Zq7a4L2onlTuYO8.png)

子网数为8，子网号与主机号共8位，256种可能，分成8份，每种32个地址。

第一个子网起始地址为0网络地址，到第32个地址为31广播地址。可分配范围1~30。

第二个子网起始地址为32，到第32个地址为63，范围33~62。

以此类推

三：64、95、65~94

四：96、127、79~126

五：128、159、129~158

六：160、191、161~190

七：192、223、193~222

八：224、255、225~254

### 变长的子网掩码

![image-20210419105911282](https://i.loli.net/2021/05/19/sQBzKjbD2wlmCTR.png)

根据每个主机的需求分配$2^n$个地址。

| 网络号 | 需求 | 分配数 |
| ------ | ---- | ------ |
| N1     | 9    | 16     |
| N2     | 28   | 32     |
| N3     | 15   | 16     |
| N4     | 13   | 16     |
| N5     | 4    | 4      |

从218.75.230.0/24中先分大的，再分小的

![image-20210419110300881](https://i.loli.net/2021/05/19/qvpTSrVMo9hkZan.png)

`0~31，32~47、48~63、64~79、80~83`

![image-20210419110429161](https://i.loli.net/2021/05/19/4cRLDkw9YxdoXOH.png)

| 网络号 | 需求 |
| ------ | ---- |
| N1     | 63   |
| N2     | 23   |
| N3     | 13   |
| N4     | 4    |

192.168.252.0是C类地址

定长子网掩码：4个子网，占两位，每个子网还有$2^6$个可分配，满足要求。
$$
\frac {256}{4} = 64
$$
一：0、63、1~62

二：64、127、65~126

三：128、191、129~190

四：192、255、193~254

| 网络号 | 需求 | 分配数 |
| ------ | ---- | ------ |
| N1     | 63   | 64     |
| N2     | 23   | 32     |
| N3     | 13   | 16     |
| N4     | 4    | 4      |

`0~63，64~95、96~111、112~115`

## IP数据报的发送和转发过程

* IP数据报的发送和转发过程包含以下部分
  * 主机发送IP数据报
  * 路由器转发IP数据报

![image-20210419144436118](https://i.loli.net/2021/05/19/uAPSfcGlb36MKJW.png)

![image-20210419144549410](https://i.loli.net/2021/05/19/yu38LHJj5k1dAh9.png)



![image-20210419144601224](https://i.loli.net/2021/05/19/FSWvu23DNXJ5zQr.png)

间接交付：如果要转发，源主机怎么知道不在同一网络的呢？与掩码相与可得到网络地址，比较网络地址即可。

![image-20210419144801157](https://i.loli.net/2021/05/19/eNYu5MByfdcjkOo.png)

主机C怎么知道要交给哪个路由器进行转发？

各网络间的主机要完成通信就必须要指定一个默认路由器帮忙转发，这个路由器被称为默认网关。

![image-20210419145309829](https://i.loli.net/2021/05/19/CrFnBKvo6RMsTh8.png)

如果要各网络之间通信，主机就把IP数据报发给默认网关，由默认网关转发出去。

![image-20210419145535221](https://i.loli.net/2021/05/19/aBsMLcRgk6X3oWQ.png)

目的地址与路由表中的地址掩码相与，得到目的网络，通过相应的接口转发。

![image-20210419145813027](https://i.loli.net/2021/06/01/MNomJUK7dClgzaW.png)

![image-20210419145948627](https://i.loli.net/2021/06/01/OWsluU6hApbxrcz.png)

路由器不转发广播IP数据报。

![image-20210419150102100](https://i.loli.net/2021/06/01/XUBvpeEKoOGD1iY.png)

![image-20210419150114430](https://i.loli.net/2021/06/01/C4UdZSmjRb9wMTO.png)

![image-20210419150146676](https://i.loli.net/2021/06/01/BxZ1vEOszAycJIr.png)

![image-20210419150137992](https://i.loli.net/2021/06/01/ZyujGhSJWMnvOgs.png)

![image-20210419150219996](https://i.loli.net/2021/06/01/zvG1SaX53jg7JmC.png)

默认网关配置错误，DHCP服务器不会转发。

![image-20210419150321083](https://i.loli.net/2021/06/01/lxJjDCW4wPbdFm9.png)

## 静态路由配置及其可能产生的路由环路问题

![image-20210419190210995](https://i.loli.net/2021/06/01/Slo9ZR31CmJdBkg.png)

### 静态路由配置

![image-20210419190347510](https://i.loli.net/2021/06/01/TJSlbZeIKorQU1m.png)

人工配置路由

![image-20210419190541505](https://i.loli.net/2021/06/01/3t57CV8hNg4reXs.png)

### 默认路由

![image-20210419190724446](https://i.loli.net/2021/06/01/7fg5LSYqKtdD3vJ.png)

如果想转发给图中的因特网，总不能把网中的所有地址都配置进路由表R1。所以给一个默认路由，找不到时就走它。

![image-20210419190939712](https://i.loli.net/2021/06/01/hskY4GM1OrCDuw6.png)

默认路由：0.0.0.0/0，如图，默认路由与路由表上面一个相同下一跳(都是R2)，可以把上面的删除。

### 特定主机路由

![image-20210419191407818](https://i.loli.net/2021/06/01/BFEaoQrdbeU8RWS.png)



### 静态路由配置错误导致的环路问题

#### 死循环

初始条件：

![image-20210419191537879](https://i.loli.net/2021/06/01/dDRmXaUVPHtfcn2.png)

要做的事：

![image-20210419191607940](https://i.loli.net/2021/06/01/jQcHqFu7UnSEbRk.png)

本来根据路由表要转发给10.0.0.1但是如果下一跳错了。

![image-20210419191700492](https://i.loli.net/2021/06/01/MPjITunY8GFozHd.png)

TTL防止环路问题。

#### 聚合了不存在的网络

初始条件：

![image-20210419192037746](https://i.loli.net/2021/06/01/iyN2prcTnJSUVIs.png)

正常情况下：

![image-20210419192208286](https://i.loli.net/2021/06/01/6THywrluaGvFcqK.png)

聚合会使R2转发不存在的网络。

![image-20210419192641678](https://i.loli.net/2021/06/01/uAI3TorMKjlkbg5.png)

对于图中右上角黑色字体的网络，本来R2是不予转发的，但是聚合会让其转发给R1，R1再转发给R2，产生了环路。

解决方案：设置黑洞路由

![image-20210419192927324](https://i.loli.net/2021/06/14/jInCsLOBQ6FV4JN.png)

黑洞路由前缀更长，会走黑洞路由。

#### 网络故障可能导致的路由环路问题

初始条件：R1检测到接口0直连的网络出现的故障。就会删除路由表中的条目。

![image-20210419193017678](https://i.loli.net/2021/06/14/3zTUtfubaCI5kZ2.png)

产生路由环路：

![image-20210419193141182](https://i.loli.net/2021/06/14/Fw92u3PsR5GoHQU.png)

设置故障网络为黑洞：

![image-20210419193253965](https://i.loli.net/2021/06/14/VXH2OGy7PkW8c4Q.png)

如果故障消除，R1自动配置。人工配置失效。

![image-20210419193341800](https://i.loli.net/2021/06/14/VXH2OGy7PkW8c4Q.png)

R1会自动检测网络好坏，第一次需要人工设置黑洞，后面发现故障会设置黑洞生效。

## 路由选择协议

### 概述

* 静态路由选择

> 人工配置的网络路由、默认路由、特定主机路由、黑洞路由等都属于静态路由。

> 配置简单、开销小。但不能及时适应网络状态（流量、拓扑）的变化。

在小规模网络中采用

* 动态路由选择

> 路由器通过路由选择协议自动获取路由信息

> 比较复杂、开销比较大。
>
> 能较好地适应网络状态的变化。

适用于大规模网络。

* 因特网所采用的路由选择协议的主要特点：
  * 自适应：动态路由选择，能较好地适应网络状态的变化
  * 分布式：路由之间交换路由信息
  * 分层次：将整个因特网划分为许多较小的自治系统AS（Autonomous System）

### 因特网采用分层次的路由选择协议

![image-20210421092414541](https://i.loli.net/2021/06/14/lkPG8iU3J6YLwSX.png)

> RFC原来采用网关这个名词来表示路由器，图中的G(gateway)表示网关，现在的RFC用字母R(router)来替代G了。内部路由协议IRP。

IGP与EGP是路由选择协议的分类名称，而不是具体的路由选择协议。

<font color = red>各自治系统内部使用的具体的内部网关协议与其它系统无关。</font>

![image-20210421093207438](https://i.loli.net/2021/06/14/CAtZ69sbgpzvlNf.png)

常见的路由选择协议

![image-20210421093239853](https://i.loli.net/2021/06/14/DsWVqFQYLGy5xbj.png)

### 路由器的基本结构

![image-20210421093731860](https://i.loli.net/2021/06/14/KxZ9wLHfgJtBSaT.png)

路由选择处理机根据使用的路由选择协议周期性地与其他路由器进行路由信息的交互，更新路由表。

数据转发过程：

1. 信号从输入端口进入路由器，物理层转化为比特流送交数据链路层处理。

2. 数据链路层从比特流中识别出帧，去掉帧的头尾，送交网络层处理。

3. 

   1. 如果送交网络层的分组是普通待转发的数据分组。 则根据分组首部的目的地址进行查表转发，没有匹配则丢弃，有否通过端口转发。

      ![image-20210421095220918](https://i.loli.net/2021/06/14/GYhHWQ3ef5g6OVv.png)

   2. 网络层更新数据字段的值，例如将数据分组的时间减1，然后送交数据链路层。

   3. 数据链路层将数据分组封装成帧，送交物理层。

   4. 物理层将帧看作比特流，转化为电信号发送。

4. 

   1. 如果送交网络层的分组是路由器之间交换路由信息的路由报文，则把这种分组送交路由选择处理机。

   2. 路由选择处理机根据分组内容更新自己的路由表。

      ![image-20210421095929338](https://i.loli.net/2021/06/14/zWh7dNCFLalUokP.png)

路由选择处理机除了处理收到的路由报文外，还会周期性的给其他路由器发送自己所知道的路由信息。

![image-20210421100153561](https://i.loli.net/2021/06/14/fspZFcYztDX6i2B.png)

输入缓冲区与输出缓冲区用来暂存，来不及处理与来不及发送的分组。

## 路由信息协议RIP的基本工作原理

![image-20210421102552351](https://i.loli.net/2021/06/14/4C9eVSbmN6olqKi.png)

思科路由器将路由器到直连网络的距离定义为0。

![image-20210421102710546](https://i.loli.net/2021/06/14/ShYybef15XaxBLg.png)

![image-20210421102726628](https://i.loli.net/2021/06/14/jILEspxATu3Kbci.png)

![image-20210421102837307](https://i.loli.net/2021/06/14/JoqK91Q2R68MDPw.png)

![image-20210421102913348](https://i.loli.net/2021/06/14/va6RTEkOp2uVlcw.png)

### 更新规则

将相邻路由表距离加1，下一跳为相邻路由表，好的就放入自己中。

![image-20210421103008728](https://i.loli.net/2021/06/14/4FdYw7mCIN8kpl5.png)

![image-20210421103221211](https://i.loli.net/2021/06/14/YMZ2EXu1Qo5H7Os.png)

![image-20210421103242652](https://i.loli.net/2021/06/14/mGMcl2HXSvOb3Yj.png)

### 存在问题

![image-20210421103326603](https://i.loli.net/2021/06/14/LQ78yOYr52toP93.png)

![image-20210429203537234](https://i.loli.net/2021/06/15/5OvoFIfuGwZi7CV.png)

![image-20210421103621848](https://i.loli.net/2021/06/15/zSlbLEFqdOA4Gth.png)

根据“R3检测到网络不可达“可知，其两者是直连的。

R3给R通告了一次后，R2将下一跳改为R3，距离为16，再更新后收到R1的路由表，又变成了可达。距离为3。

![image-20210421104729021](https://i.loli.net/2021/06/15/5dNFuve6StUinHE.png)

![image-20210421103702309](https://i.loli.net/2021/06/15/84OYR3ukclWdrCz.png)

## 开放最短路径优先OSPF的基本工作原理

> * 开放最短路径优先OSPF(Open Shortest Path First)，是为了克服RIP的缺点在1989年开发出来的。
>   * “开放”——公开发表
>   * “最短路径优先”——最短路径算法SPF
> * OSPF是基于链路状态的，而不像RIP是基于距离向量的
> * OSPF采用SPF算法计算路由，从算法上保证了不会产生路由环路
> * OSPF不限制网络规模，更新效率高，收敛速度快
> * 链路状态是指本路由器都和哪些路由器相邻，以及相应链路的的“代价(const)“。
>   * “代价”用来表示费用、距离、时延、带宽等等，这些都是由网络管理人员来决定

![image-20210422103625111](https://i.loli.net/2021/06/15/CdrGm4btNFohfg3.png)

![image-20210422103727995](https://i.loli.net/2021/06/15/RnKyWJsm6Of3ZGE.png)

相互告知信息：

![image-20210422103919472](https://i.loli.net/2021/06/15/xQUoaqeY7Mf8nOL.png)

链路状态数据库保存信息：

![image-20210422104019217](https://i.loli.net/2021/06/15/59BkduponQvW3S1.png)

由算法得出最短路径：

![image-20210422104146861](https://i.loli.net/2021/06/15/O4gRzpKv3AdiWeV.png)

![image-20210422104318101](https://i.loli.net/2021/06/15/635ycNiAP41l2v7.png)

### 工作过程

1. R1与R2周期性发送问候分组，以便建立和维护邻居关系。
2. 给邻居路由器发送数据库描述分组（将自己链路状态数据库中的所有链路状态项目的摘要信息发送给邻居路由器）。
3. 如果R1收到分组后发现自己少了某些链路状态项目，于是给对方发送链路请求分组。
4. R2收到R1的链路请求分组后，将R1所缺少的链路状态项目的详细信息封装在链路状态更新分组中，发送给R1。
5. R1收到R2发来的更新分组后，添加到自己的链路状态数据库中，并给R2发送链路状态确认分组。
6. 最终达到同步。

![image-20210422104514654](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422104514654.png)

### OSPF在多点接入网络中路由器邻居关系的建立

![image-20210422105448638](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422105448638.png)

![image-20210422105826143](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422105826143.png)

主干路由器是指在主干区域内的路由器。可以把区域边界路由器看作是主干路由器。 

## 边界网关协议BGP基本工作原理

![image-20210422155605005](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422155605005.png)

* 内部网关协议IGP(例如路由信息协议RIP或开放最短路径优先OSPF)

  * 设法使分组在一个自治系统内尽可能有效地从源网络传输到目的网络
  * 无需考虑自治系统外部其他方面的策略

* 外部网关协议EGP(例如国这界网关协议BGP)

  * 在不同自治系统内，度量路由的“代价”(距离、带宽、费用等)可能不同。因此，对于自治系统之间的路由选择，使用“代价”作为度量来寻找最佳路由是不行的。

    ![image-20210422160102029](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422160102029.png)没有统一的路由度量，寻找最佳路由是没有意义的。

  * 自治系统之间的路由选择必须考虑相关策略(政治、经济、安全等)

    ![image-20210422160441176](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422160441176.png)

  * BGP只能是力求寻找一条能够到达目的网络且比较好的路由(不能兜圈子)，而并非要寻找一条最佳路由。

![image-20210422160622605](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422160622605.png)

![image-20210422160708887](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422160708887.png)

![image-20210422160922295](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422160922295.png)

![image-20210422161032681](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422161032681.png)

![image-20210422161152278](https://i.loli.net/2021/04/22/pacFRDmyATOSdJC.png)

![image-20210422161336208](https://i.loli.net/2021/04/22/HDnAOj71teBVWr8.png)

## IPv4数据报的首部格式

![image-20210422165203252](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210422165203252.png)

### 版本

> 占4bit，表示IP协议的版本。通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议版本号为4(即IPv4)

### 首部长度

> 占4bit，表示IP数据报首部的长度。该字段的取值以4字节为单位。
>
> 最小十进制取值为5，表示IP数据报首部只有20字节的固定部分。(5x4 = 20)
>
> 最大十进制取值为15，表示IP数据报首部包含20字节固定部分和最大40字节可变部分。(15x4 = 60 = 20 +40)

### 可选字段

> 长度从1个字节到40个字节不等。用来支持排错、测量及安全等措施。可选字段增加了IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理IP数据报的开销。实际上可选的字段很少被使用。

### 填充字段

> 确保首部长度为4字节的整数倍。使用全0进行填充。
>
> 因为可变部分是1到40个字节不等，所以首部在[20, 60]之间，要求首部以4字节为单位，少的用0填充。

### 区分服务字段

> 占8bit，用来获得更好的服务。
>
> 该字段在旧标准中叫作服务类型，但实际上一直没有被使用过。
>
> 1998年，因特网工程任务组IETF把这个字段改名为区分服务。利用该字段的不同数值可提供不同等级的服务质量。只有在区分服务时，该字段才起作用。一般情况下都不使用该字段。

### 总长度字段

> 占16个bit，表示IP数据报的总长度(首部+数据载荷)，最大取值为十进制的65535，以字节为单位。

![image-20210422171101282](https://i.loli.net/2021/04/22/7SeL81sKIRtj6WU.png)

![image-20210422171338402](https://i.loli.net/2021/04/22/ab7cquXfk31OgxS.png)

### 标识字段

> 占16比特，属于同一个数据报的各分片数据报应该具有相同的标识。
>
> IP软件维持一个计数器，每产生一个数据报，计数器值加1，并将此值赋给标识字段。

### 标志字段

> 占3比特，各比特含义如下：
>
> DF位：1不允许分片
>
> ​			0 允许分片
>
> MF：1后面还有分片
>
> ​		  0这是最后一个分片
>
> 保留位：必须为0

### 片偏移字段

> 占13bit，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位。片偏移以8个字节为单位。

![image-20210422181538992](https://i.loli.net/2021/04/22/GOgWBrQ3lpjJdxh.png)

![image-20210422181606192](https://i.loli.net/2021/04/22/794jmELyPg6nJwC.png)

### 生存时间TTL

> 占8bit，最初以秒为单位，最大生存周期为255秒；路由器转发IP数据报时，将IP数据报首部中的该字段的值减去IP数据报在本路由器上所耗费的时间，若不为0就转发，否则就丢弃。
>
>  现在以“跳数“为单位，路由器转发IP数据报时，将IP数据报首部中的该字段的值减1，若不为0就转发，否则就丢弃。

![image-20210422181945525](https://i.loli.net/2021/04/22/WaH3Z7ubqfzlnx8.png)

### 协议字段

> 占8bit，指明IPv4数据报的数据部分是何种协议数据单元。

![image-20210422182054936](https://i.loli.net/2021/04/22/d5QAKaEtReo3rU9.png)

![image-20210422182128070](https://i.loli.net/2021/04/22/Ju7hq6bQn9GHYF1.png)

### 首部检验和字段

> 占16bit，用来检测首部在传输过程中是否出现差错。比CRC检验码简单，称为因特网检验和。
>
> IP数据报每经过一个路由器，路由器都要重新计算首部检验和，因为某些字段（生存时间、标志、片偏移等）的取值可能发生变化。
>
> 由于IP层本身并不提供可靠传输服务，并且计算首部检验和是一项耗时的操作，因此在IPv6中，路由器不再计算首部检验和，从而更快转发IP数据报。

### 源IP地址和目的IP地址

> 各占32bit，用来填写发送该IP数据报的源主机的IP地址和接收该IP数据报的目的地主机的IP地址。

![image-20210422183218505](https://i.loli.net/2021/04/22/befpZEC84Sxtr7Y.png)

片偏移量必须为整数。

![image-20210422184328793](https://i.loli.net/2021/04/22/KfpOA8x4NTXZkLm.png)

IP分组是封装在以太网帧的数据部分的。

![image-20210422184429543](https://i.loli.net/2021/04/22/coKxypMTROq4vkn.png)

![image-20210422184445949](https://i.loli.net/2021/04/22/npahHfmiy5YlBM8.png)

## 网际控制报文协议ICMP

* 为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP(Internet Control Message Protocol)
* 主机或路由器使用ICMP来发送差错报告报文和询问报文
* ICMP报文被封装在IP数据报中发送

ICMP差错报告报文共有以下五种：

### 1. 终点不可达

![image-20210426203441638](https://i.loli.net/2021/04/26/koRZXcPJF4NtlSm.png)

### 2. 源点抑制

![image-20210426203545651](https://i.loli.net/2021/04/26/yaO6NsLiXYwqlpu.png)

### 3. 时间超过

![image-20210426203652192](https://i.loli.net/2021/04/26/ZwaEgC7HptFU5X1.png)

![image-20210426203725913](https://i.loli.net/2021/04/26/W4UVC2rYdxEBeyh.png)



### 4. 参数问题

![image-20210426203753626](https://i.loli.net/2021/04/26/mngbTe1NXEi87ac.png)

### 5. 改变路由(重定向)

![image-20210426203826043](https://i.loli.net/2021/04/26/zvle26WQTpi81dy.png)

![image-20210426203849798](https://i.loli.net/2021/04/26/W1LQZweSjluHdmv.png)

### ICMP询问报文

![image-20210426204105629](https://i.loli.net/2021/04/26/5ir8jQt7Ng9Jzak.png)

### ICMP典型应用

![image-20210426204203053](https://i.loli.net/2021/04/26/Qm2yJBuK9Y6Lanf.png)

![image-20210426204316392](https://i.loli.net/2021/04/26/LepnEF2w3vJYDlh.png)

![image-20210426204351832.png](https://i.loli.net/2021/04/26/difrQUE84p75yWj.png)



## 虚拟专用网vpn与网络地址转换net

> 虚拟专用网VPN(Virtual Private Network)

![image-20210426212750891](https://i.loli.net/2021/04/26/2Mkge6G8KoEQSsB.png)

![image-20210426213017392](https://i.loli.net/2021/04/26/rbpPF6G15ConsAz.png)

逻辑上R1与R2之间好像是直通的点对点链路。

![image-20210426213221761](https://i.loli.net/2021/04/26/Fj6altI2RCWfvqc.png)

> 网络地址转换NAT(Network Address Translation)

通过NAT路由器分配临时IP地址，将IP数据报的源地址修改为个地址，对应关系记录下来，就可以转发。

![image-20210426213717694](https://i.loli.net/2021/04/27/uY9HkQtGqW8JLIx.png)

![image-20210426213757070](https://i.loli.net/2021/04/27/juP4QDfa5VwLhAo.png)

![image-20210426213846671](https://i.loli.net/2021/04/27/GDyC3pzPAsL7knt.png)

![image-20210426213930063](https://i.loli.net/2021/04/27/ubYhTIyKe1j5UiN.png)

![image-20210426214005321](https://i.loli.net/2021/04/27/m5vB94U1VJj78hR.png)

![image-20210426214046912](https://i.loli.net/2021/04/27/fQw6yPFdo8ibWnr.png)

# 运输层

## 概述

![image-20210504160818680](https://i.loli.net/2021/05/04/2BT1NFvk8RWnMSJ.png)

![image-20210504161047438](https://i.loli.net/2021/05/04/1HKQNpDOwGmCdnL.png)

运输层向高层用户屏蔽了下面网络核心的细节（如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就好像是在两个运输层实体之间有一条端到端的逻辑通信信道。

根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输协议，即面向连接的TCP和无连接的UDP，这两种协议就是本章要讨论的主要内容。

## 运输层端口号、复用、分用

![image-20210504210658440](https://i.loli.net/2021/05/04/B6qZSv1N4EpsnxJ.png)

简单来说，就是应用进程要通信，找不着地址怎么行？用端口号来找地址，只对本计算机有用。

![image-20210504211022794](https://i.loli.net/2021/05/04/ZCXxld5GbpSjvTq.png)复用就是多个用一个，分用就是一个变多个。

发送方的某些报文用运输层的UDP协议进行封装就叫UDP复用。这些报文是不同应用进程的，有不同的端口号。两者在网络层封装为IP数据报，这叫作IP复用。

接收方对IP数据报进行IP分用，上交运输层不同的协议，再由运输层进行UDP与TCP分用。

![image-20210504212030412](https://i.loli.net/2021/05/04/6xTSE95X8WGB1sU.png)

DNS服务器记录有该域名对应的IP地址。

![image-20210504212308450](https://i.loli.net/2021/05/04/j2pATFEWJtGXROq.png)

模拟在浏览器中输入域名后的操作。

用户PC中的DNS客户端进程会发送一个DNS查询请求报文，DNS查询请求报文需要使用运输层的UDP协议，封装成用户数据报。源端口字段的值在短暂端口号49151\~65535中挑选一个未被占用的，用于表示客户端进程。目的端口号就是53，这是DNS服务端进程所使用的熟知端口号。

将UDP数据报封装在IP数据报中，通过以太网发送给DNS服务器。

![image-20210504213748595](https://i.loli.net/2021/05/04/mSnCiYy9AX27I5f.png)

DNS服务器收到数据报后，用中解封出UDP数据报，从中看到目的端口的地址是53，表明应将UDP用户数据报的数据载荷部分（DNS查询请求报文）交付给本服务器中的DNS服务器端进程。

DNS服力器端进程解析DNS查询请求报文的内容，按要求查找对应的IP地址，DNS响应报文通过UDP协议封装成UDP数据报，再将UDP数据报封装成IP数据报通过以太网发送给用户主机。

![image-20210504214354141](https://i.loli.net/2021/05/04/ZhBd7FircfLSGkK.png)

同理，用户PC从IP数据报中解封出UDP用户数据报，通过目的端口号将DNS响应报文交付给DNS客户端进程，进程解析后得到原先域名对应的IP地址。

同理主机发送通过TCP协议及IP协议封装的HTTP请求：

![image-20210504215231713](https://i.loli.net/2021/05/04/FzkBu78Uq91ZHlN.png)

![image-20210504215435327](https://i.loli.net/2021/05/04/e59hO48xMNwBAQU.png)

经过一系列解析HTTP客户端进程解析HTTP响应报文中的内容，在网页浏览器中显示。

![image-20210504215459309](https://i.loli.net/2021/05/04/Opu71Ydv8VFtjLh.png)

## 对比UDP与TCP

> UDP和TCP是TCP/IP体系结构运输层中的两个重要协议

![image-20210505091221151](https://i.loli.net/2021/05/05/N9vyhEcQrpkwJSz.png)

UDP(User Datagram Protocol)用户数据报协议

TCP(Transmission Control Protocol)传输控制协议

![image-20210505091658168](https://i.loli.net/2021/05/05/ASnF8YJseXN9GEp.png)

使用UDP协议的双方可以随时发送协议。TCP则要先建立连接。

---

![image-20210505091923449](https://i.loli.net/2021/05/05/PIqfhuobWNTABgt.png)

TCP要先建立连接，然后可将传输认为是在一条信道上传输的。

---

![image-20210505092305336](https://i.loli.net/2021/05/05/XSLstnqEZ3u5Ora.png)

UDP对应用层报文添加头部，并不对应用层报文做任何操作。

发送方的TCP将发送方应用进程交付下来的数据看成是一连串的、无结构的字节流。TCP不知道这些字节流的含义，仅将它们编号，存储在自己的发送缓存中。TCP根据发送策略，从发送缓存中提取一定数量的字节，构建TCP报文段并发送。

接收方TCP从报文段中取出数据载荷部分并存储在接收缓存中；同时将缓存中的字节交付给应用进程。TCP不保证发送的数据块与接收的数据块有对应的大小的数据关系。

> 发送方应用进程交给发送方TCP共10个数据块，接收方的TCP可能可用了4个数据块就把收到的字节流交付给了上层的应用进程。
>
> 但两个字节流必须完全一样。

TCP是全双工通信。

---

![image-20210505093655041](https://i.loli.net/2021/05/05/QgU5NiKWzr4PDsC.png)

尽管IP协议向上层提供的是无连接的不可靠服务，但只要运输层使用TCP协议就可向其上层提供面向有连接的可靠传输服务。

---

![image-20210505094145825](https://i.loli.net/2021/05/05/qE5sv3kig9zeDPy.png)

![image-20210505094203904](https://i.loli.net/2021/05/05/8zYdrmNuULjTnMH.png)

## TCP流量控制

![image-20210505095748660](https://i.loli.net/2021/05/05/WRLSAftlhqgQ2oi.png)

![image-20210505100308142](https://i.loli.net/2021/05/05/pSOgZsdGkK5Bl2N.png)

![image-20210505100348676](https://i.loli.net/2021/05/05/SPVdHMbyXkIQrqs.png)

![image-20210505100431063](https://i.loli.net/2021/05/05/bs8FnuDmLrgUlyZ.png)

![image-20210505100926896](https://i.loli.net/2021/05/05/9HR4QelUqaScWDf.png)

## TCP拥塞控制

![image-20210506111246643](https://i.loli.net/2021/05/06/C8g4R2jTKzwsuoQ.png)

TCP的四种拥塞控制算法：

### 1. 慢开始(slow-start)

![image-20210506111702069](https://i.loli.net/2021/05/06/lNQSU5umWHrzafK.png)

![image-20210506112158051](https://i.loli.net/2021/05/06/lYgc6afUVLuoAHT.png)

慢开始：拥塞窗口小于慢开始门限值时使用。算法按指数增加。

| 轮次 | 拥塞窗口 | 数据报 |
| ---- | -------- | ------ |
| 0    | 1        | 0      |
| 1    | 2        | 1~2    |
| 2    | 4        | 3~6    |
| 3    | 8        | 7~14   |
| 4    | 16       | 15~30  |
| ...  | ...      | ...    |

![image-20210506113016582](https://i.loli.net/2021/05/06/R2iryxsaEJmGMuf.png)

### 2. 拥塞避免(congestion avoidance)

达到慢开始门限时，改用拥塞避免算法。算法每次只加1。

| 轮次 | 拥塞窗口 | 数据报  |
| ---- | -------- | ------- |
| 5    | 17       | 31~47   |
| 6    | 18       | 48~65   |
| 7    | 19       | 66~84   |
| 8    | 20       | 85~104  |
| 9    | 21       | 105~125 |
| 10   | 22       | 126~147 |
| 11   | 23       | 148~170 |
| 12   | 24       | 171~194 |

![image-20210506113705975](https://i.loli.net/2021/05/06/aMPLWnJ24IG9Ccv.png)

如果丢失就必然会造成超时重传。发送方以此认为网络出现了拥塞。

![image-20210506113905044](https://i.loli.net/2021/05/06/m4EhazwZKV9UJiR.png)

![image-20210506114436780](https://i.loli.net/2021/05/06/in3Eg9zsS1hpHoq.png)

当下一次到慢开始门限值时，又再开始执行拥塞算法。以此往复。

![image-20210506113951361](https://i.loli.net/2021/05/06/3oaFNjIAWsGgYfH.png)

![image-20210506115015291](https://i.loli.net/2021/05/06/KCFWylaILvzPuZO.png)

个别报文段的丢失并不是网络拥塞，却被错误的认为是拥塞。

### 3. 快重传(fast retransmit)

![image-20210506115405914](https://i.loli.net/2021/05/06/TSC1BPpQtNA7gEZ.png)

### 4. 快恢复(fast recovery)

真正的拥塞是不会有重复确认的（堵了）。

![image-20210506115722157](https://i.loli.net/2021/05/06/kiHV1ghTfUJKPZ7.png)

整体运行图如下：

![image-20210506115957339](https://i.loli.net/2021/05/06/sEUxA2f8gBjThvD.png)

![](https://i.loli.net/2021/05/06/Nc8LqMbd6K2yJRQ.png)

注意：超时就要再次慢开始，而不是快恢复。显然三次重复确认的时间一般要小于超时时间。

## TCP超时重传时间的选择

超时重传时间RTO比往返时间RTT0的值要小：

![image-20210508095024109](https://i.loli.net/2021/05/08/29CPbfHTVcm5R3h.png)

超时重传时间RTO比往返时间RTT0的值要大：

![image-20210508095125839](https://i.loli.net/2021/05/08/xMyjtpYAEDnG6Xz.png)

RTO应略大于往返时间。

![image-20210508095207764](https://i.loli.net/2021/05/08/rAoF7OaScX13P54.png)

但是在复杂的互联网环境下，往返时间并不是确定的

![image-20210508095401488](https://i.loli.net/2021/05/08/5uryWP8NpjS6v9Q.png)

![image-20210508095451718](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210508095451718.png)

![image-20210508100551760](https://i.loli.net/2021/05/08/CxDu15yzd2ASFJ6.png)

往返时间RTT的计算比较复杂

![image-20210508100801578](https://i.loli.net/2021/05/08/qYRibI2PhvOdjJ1.png)

![image-20210508100844850](https://i.loli.net/2021/05/08/tIpaKVcin8LqR6e.png)

保证突然增大时，RTO也会增加。

![image-20210508101024260](https://i.loli.net/2021/05/08/k45MVqBwpzaWcbY.png)

![image-20210508101108775](https://i.loli.net/2021/05/08/MmdtWSQxDyk5hTw.png)

## TCP可靠传输的实现

> TCP基于以字节为单位的滑动窗口来实现可靠传输。

举例：假定数据只在一个方向上进行

假定在此时接收方回复的确认报文段：

> rwnd = 20
>
> ack = 31

网络不存在拥塞问题。

![image-20210508103115114](https://i.loli.net/2021/05/08/ryKxI5lSoftGYvz.png)

现在，假定发送方将发送窗口内序号31~41的数据，封装在几个不同的报文段中发送出去。

![image-20210508103445733](https://i.loli.net/2021/05/08/vXw8QNBjHI9gf5D.png)

接收方只能对按序到达的最后一个序号给出确认。假设发送方发送的封装有32~33的报文段到达了接收文，显然是没有按序到达，31号可能是丢了，也可能是滞留在网络中。接收方接受数据序号落在接收窗口内的数据报文段，存入接收缓存。

![image-20210508104037124](https://i.loli.net/2021/05/08/JhuUacY85zqN2RQ.png)

接收方发送确认报文段，窗口大小不变，希望接收31号数据。

发送方知道了接收方收到了未按序到达的数据，且31号没到达接收方，第一次重复确认（3次重复确认才会引起快重传），所以不会快重传。发送方发送31号数据报文段。接收方收到后就上交应用进程，窗口移动。发送确认报文段。

![image-20210508104551249](https://i.loli.net/2021/05/08/qYsQNFo4M7Z5yhx.png)

TCP是全双工通信，所以两者能同时进行，假设发送方在接收方发送了确认报文段同时也发送了数据报文段。

![image-20210508104845119](https://i.loli.net/2021/05/08/GThqXMF9CwcSAK3.png)

未按序到达，只能暂存在接收缓存中。

![image-20210508105053440](https://i.loli.net/2021/05/08/Ye8k9Rz2Nglta4j.png)

发送方在发完窗口中的所有数据后，如果没有收到接收方的确认是不能再发送新数据的，长时间未接到就会超时重传。

![image-20210508110107533](https://i.loli.net/2021/05/08/4IoVja8BfYKAqZt.png) 

![image-20210508110358455](https://i.loli.net/2021/05/08/hWLdfOXN9giYFbs.png)

确认序号是想要收到的序号，而不是已收到的最后一个。

![image-20210508110713075](https://i.loli.net/2021/05/08/4eIO712cHxrP8hG.png)

## TCP的连接建立

![](https://i.loli.net/2021/05/09/xa5QO3Yho1wsD8W.png)

* TCP的连接建立要解决以下三个问题：
  * 使TCP双方能够确知对方的存在
  * 使TCP双方能够协商一些参数（如最大窗口值，是否使用窗口扩大选项和时间戳选项以及服务质量等）
  * 使TCP双方能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配。

主动发起TCP连接的应用进程叫TCP客户，被动等待TCP连接建立的应用进程是TCP服务器。

首先TCP服务服进程创建传输控制块，存储TCP连接中的重要信息。之后就准备接受TCP客户进程的连接请求，进入“监听状态”。

![image-20210509085606271](https://i.loli.net/2021/05/09/umo59MIZTiOlkVt.png)

TCP客户进程也是首先先建立TCP传输控制块，在打算建立TCP连接时，向TCP服务器进程发送TCP连接请求报文段并进入同步已发送状态。

![image-20210509085827047](https://i.loli.net/2021/05/09/Y7EORxQdHIBzoNp.png)

> SYN同步位
>
> ACK确认位
>
> 序号字段seq
>
> 确认号字段ack(对确认请求seq+1)

SYN是同步位被设置为1，表明这是一个TCP连接请求报文段。序号字段seq被设置了一个初始值x，作为TCP客户进程所选择的初始序号。

<font color = red>TCP规定SYN被设置为1的报文段不能携带数据，但要消耗掉一个序号</font>

TCP服务器如果同意连接，就发送TCP连接请求确认报文段，并进放同步已接收状态。该报文首部中的同步位SYN与确认位ACK都设置为1，表明这是一个TCP连接请求确认报文段。序号字段seq被设置了一个初始值y，作为TCP服务进程所选择的初始序号。确认号字段ack的是值被设置为x+1。这是对TCP客户进程所选择的初始序号的确认。

TCP客户进程收到TCP连接请求确认报文段后，还要向TCP服务进程发送一个普通的TCP确认报文段并进入连接已建立状态。该报文首部中的ACK被设置为1，表明这是一个普通的TCP确认报文段。序号字段seq被设置为x+1，<font color = blue>这是因为TCP客户进程发送的第一个TCP报文段的序号为x，并且不携带数据</font>，因此第二个报文段的序号为x+1。

<font color = red>TCP规定普通的TCP确认报文段可以携带数据，如果不携带数据，则不消耗序号。</font>在这种情况下（不携带数据），所发送的下一个数据报文段的序号仍是x+1。

确认号字段的ACK被设置为y+1，这是对TCP服务器进程所选择的初始序号的确认。

TCP服务器进程收到该确认报文段后，也进入连接已建立状态。

![image-20210509092443165](https://i.loli.net/2021/05/09/8D4zbUmIXijAf7B.png)

如果使用两次握手，如果已失效的连接请求报文段突然又传送到TCP服务器，就会无故使TCP服务器进入连接已建立状态，造成资源的浪费。

![image-20210509093418408](https://i.loli.net/2021/05/09/qQU1DXcar5fjOWN.png)

## TCP的连接释放

> TCP通信双方都可以释放连接。

假设使用TCP客户进程的应用进程通知其主动关闭TCP连接，TCP客户进程会发送TCP连接释放报文段，进入终止等待1状态。

![image-20210509095309971](https://i.loli.net/2021/05/09/CpZwYIGBbh5kTQs.png)

> FIN终止位
>
> ACK确认位
>
> seq序号字段(TCP客户进程之前已传送过的、数据的最后一个字节的序号加1)
>
> ack确认号(TCP客户进程之前已收到的、数据的最后一个字节的序号加1)

<font color = red>TCP规定终止位FIN等于1的报文段即使不携带数据，也要消耗掉一个序号</font>

![image-20210509095450579](https://i.loli.net/2021/05/09/2vRieJOZzb1NMxF.png)

> seq(TCP服务进程之前传送过的数据的最后一个字节的序号加1)与它确认的TCP客户进程发送的TCP连接数据报文段中的ack匹配。

TCP服务器进程这时应通知高层应用进程：TCP客户进程要断开与自己的TCP连接。此时，从TCP客户进程到TCP服务器进程这个方向的连接就释放了。这时的TCP连接处于半关闭状态，TCP客户进程已经没有数据要发送了，但TCP服务器进程如果还有数据要发送，TCP客户进程仍要接收。

若使用TCP服务器进程的应用进程已经没有数据要发送了，应用进程就通知其TCP服务器进程释放连接。TCP连接释放是由TCP客户进程主动发起的，因此，TCP服务器进程对TCP连接的释放被称为被动关闭连接。

![image-20210509100215943](https://i.loli.net/2021/05/09/qb2EJSXCh8iYMsQ.png)

> seq序号字段，TCP服务进程可能在之前又发送了一些数据。
>
> ack确认号字段为u+1，这是对之前收到的TCP连接释放报文段的重复确认。

![image-20210509100921798](https://i.loli.net/2021/05/09/WCkjn9dEK3JOeya.png)

> seq序号字段是u+1
>
> ack确认号段是对TCP服务器进程发送TCP连接释放报文段的确认。

TCP服务器进程收到该报文段后就进入关闭状态，而TCP客户进程还要经过2MSL后才能进入关闭状态。

![image-20210509101845038](https://i.loli.net/2021/05/09/XTMLeuHoVxQykrZ.png)

有没有必要要这个时间等待？

![image-20210509102122110](https://i.loli.net/2021/05/09/tTRavB4iwkVqPgH.png)

如果最后发送的TCP确认报文段丢失了，会造成TCP服务器进程对之前的发送的TCP连接释放报文段的超进重传，一直处于最后确认状态。用时间等待就可以确保收到该情况下的重复确认，还可以使本次连接持续时间内所产生的所有报文段都从网络中消失。下一次新的TCP连接中不会出现旧的报文段。

![image-20210509102746088](https://i.loli.net/2021/05/09/1bNQxjYm58WypSe.png)

## TCP报文段的首部格式

![image-20210510091716172](https://i.loli.net/2021/05/10/hIOnvCfLAEeZkoD.png)

与IP数据报相同，由20字节的固定首部和最大40字节的扩展首部构成。

![image-20210510091820354](https://i.loli.net/2021/05/10/CZne3pXwfOKxY1E.png)

**源端口**：占16比特，写入源端口号，用来标识发送该TCP报文段的应用进程。

**目的端口**：占16比特，写入目的端口号，用来标识接收该TCP报文段的应用进程。

* TCP实现可靠传输相关字段：

  * 序号：占32比特，取值范围[0, $2^{32}-1$]，序号增加到最后一个后，下一个序号就又回到0。<font color = red>指出本TCP报文段数据载荷的第一个字节的序号。</font>

    ![image-20210510092732625](https://i.loli.net/2021/05/10/OeaJQXoYPdjqxEv.png)

  * 确认号：占32比特，取值范围[0, $2^{32}-1$]，确认号增加到最后一个后，下一个确认号就又回到0。<font color = red>指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认。</font><font color = pink>若确认号为n，则表明到序号n-1为止的所有数据都已正确接收，期望接收序号为n的数据</font>

  * 确认标志位ACK：取值为1时确认号字段才有效；取值为0时确认号字段无效。<font color = red>TCP规定，在连接建立后所有传送的TCP报文段都必须把ACK置1</font>

    ![image-20210510093354904](https://i.loli.net/2021/05/10/AytnJNEWIcY3Tk6.png)

    ==确认号是想要对方发的，序号是自己要发的。==

![image-20210510093617125](https://i.loli.net/2021/05/10/nxbz1WTYJisDME3.png)

**保留**：占6比特，保留为今后使用，但目前应置为0。

![image-20210510093910017](https://i.loli.net/2021/05/10/JDHZgmhETYw7n6f.png)

窗口大小与拥塞窗口也有关，从接收窗口与拥塞窗口中取小者。

![image-20210510094103666](https://i.loli.net/2021/05/10/NgQhVkaKdioxBtw.png)

**同步标志位SYN**：在TCP连接建立时用来同步序号。

**终止标志位FIN**：用来释放TCP连接。

**复位标志位RST**：用来复位TCP连接。<font color = red>当RST置1时，表明TCP连接出现了异常，必须释放连接，然后再重新建立连接。RST置1还用来拒绝一个非法的报文段或拒绝打开一个TCP连接。

![image-20210510094447177](https://i.loli.net/2021/05/10/kG3i4FASXgYUeVQ.png)

![image-20210510094503540](https://i.loli.net/2021/05/10/bJshAHomivL92PV.png)

**选项**

* 最大报文段长度MSS选项：TCP报文段数据载荷部分的最大长度。
* 窗口扩大选项：为了扩大窗口(提高吞吐率)
* 时间戳选项：
  * 用来计算往返时间RTT
  * 用于处理序号超范围的情况，又称为防止序号绕回PAWS
* 选择确认选项：用来实现选择确认功能

![image-20210510094824157](https://i.loli.net/2021/05/10/9jQfeCPIl6Mhc42.png)

# 应用层

## 概述

![image-20210510194743852](https://i.loli.net/2021/05/10/Jbv1VqnpPkTUWIN.png)

## 客户-服务器方式和对等方式

![image-20210510195656030](https://i.loli.net/2021/05/10/XEa5CcJDOnFRAPq.png)

## 动态主机配置协议DHCP

![image-20210510202246022](https://i.loli.net/2021/05/10/8VB26Uy9Pm7hxZW.png)

如果给网络中添加一台DHCP服务器。在其中设置好可为网络中其他各主机配置的网络配置信息。网络中的各主机在开机后自动启动DHCP程序，向DHCP服务器请求自己的网络配置信息。

![image-20210510202532065](https://i.loli.net/2021/05/10/TXbDiyMemsAo6gN.png)

DHCP使用客户服务器方式，DHCP协议是TCP/IP体系应用层中的协议，使用运输层的UDP提供的服务，DHCP报文在运输层会被封装为UDP用户数据报。网络层封装成IP数据报，数据链路层封装成帧。

> DHCP服务器：在DHCP服务器上运行DHCP服务器进程，UDP端口67
>
> DHCP客户：在用户主机上运行DHCP客户进程，UDP端口68

启用主机HCP后，DHCP客户将广播发送<font color = green>DHCP发现报文。</font>

![image-20210510204118381](https://i.loli.net/2021/05/10/v6amVI8yHQ2Jg1l.png)

IP数据报的源IP地址与目的IP地址分别是0.0.0.0与255.255.255.255（广播）。DHCP客户会把这个丢弃（没有监听该UDP用户数据报目的端口67的进程），而DHCP服务器会把它解封出封装有DHCP发现报文的UDP用户数据报。

DHCP服务器根据发现报文中封装的DHCP客户的MAC地址查找自己的数据库。

* 如果有针对该MAC地址的配置信息，就用这些配置信息构建并发送<font color = orange>DHCP提供报文。</font>
* 如果没有，则采用默认配置信息来构建并发送<font color = orange>DHCP提供报文。</font>

![image-20210510205213076](https://i.loli.net/2021/05/10/SEbTdlM47L3mgPY.png)

DHCP客户将DHCP提供报文的事物ID与自己此前发送的发现报文的进行匹配，如果相等就接受该报文。否则就丢弃。图中客户端可能会收到两个DHCP提供报文，会选择先到的那一个，并向所选择的DHCP服务器发送<font color = blue>DHCP请求报文。</font>请求某个DHCP服务器作为自己的DHCP服务器。要收到那个服务器的确认，才可以正式使用向该DHCP服务器租用的IP地址。

![image-20210510210051405](https://i.loli.net/2021/05/10/4NIyw82lBqcSDP7.png)

如果服务器接受，就会给DHCP客户发送<font color = lhgreen>DHCP确认报文。</font>

![image-20210510210538640](https://i.loli.net/2021/05/10/mFOtZUEz4dlAgrI.png)

租用期过半，客户端再发送<font color = blue>DHCP请求报文。</font>

![image-20210510210809931](https://i.loli.net/2021/05/10/3nKXBM2L15yehlg.png)

**DHCP释放报文**

![image-20210510211014561](https://i.loli.net/2021/05/10/d79qUZiBeHLwkCz.png)

路由器不会转发广播报文，所以在有路由器的网络中，需要给该路由器配置DHCP服务器的IP地址并使之成为DHCP的**中继代理**。由路由器单播给它。

![image-20210510211325357](https://i.loli.net/2021/05/10/JhOkDR8t617sCdf.png)

## 域名系统(DNS)

> Domain Nmae System，通过域名得到IP地址。DNS服务器中有域名与IP地址映射关系的数据库。

![image-20210512092341897](https://i.loli.net/2021/05/12/QxmIrW2FV4qDwud.png)

![image-20210512092529217](https://i.loli.net/2021/05/12/3PCQBwVZjb5kaE8.png)

![image-20210512092611438](https://i.loli.net/2021/05/12/EZlFAI6nWTNpMHG.png)

![image-20210512092810230](https://i.loli.net/2021/05/12/dmGqJIUi5l9yA61.png)

![image-20210512093206048](https://i.loli.net/2021/05/12/Hu3cYQTfiKwBsIo.png)

![image-20210512093234811](https://i.loli.net/2021/05/12/a7ut1AXMChs3FwT.png)

![image-20210512093417902](https://i.loli.net/2021/05/12/9XPnsSmkAqiIrMe.png)

![image-20210512093433160](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210512093433160.png)

![image-20210512093502091](https://i.loli.net/2021/05/12/plr85ANqFS9gbae.png)

![image-20210512093519594](https://i.loli.net/2021/05/12/lyxbseAXG5IUS6h.png)

**DNS报文使用运输层的UDP协议进行封装，运输层端口号为53**

## 文件传送协议FTP

![image-20210512095914583](https://i.loli.net/2021/05/12/OBKapDzg7ZtVuL3.png)

FTP采用客户-服务器方式。

![image-20210512100123236](https://i.loli.net/2021/05/13/K18lPTDYLfmOBbv.png)

![image-20210512101147377](https://i.loli.net/2021/05/13/Fu8xLIQks1V9AWP.png)

可以用浏览器或者CMD来访问。

![image-20210512101348519](https://i.loli.net/2021/05/13/uDg7fvR4AiJKLy6.png)

![image-20210512101631178](https://i.loli.net/2021/05/13/FrMcJASG7zaXp9D.png)

<font color = orange>控制连接在整个会话期间一直保持打开，用于传送FTP相关控制命令</font>

<font color = blue>数据连接用于文件传输，在每次文件传输时才建立，传输结束就关闭</font>

![image-20210512101817603](https://i.loli.net/2021/05/13/dsRHVwhumlXFJLg.png)

![image-20210512101828618](https://i.loli.net/2021/05/13/yqED83b4AhLl1nO.png)

## 电子邮件

![image-20210513083930466](https://i.loli.net/2021/05/13/7cYAbjCDZmPhWiS.png)

* 电子邮件系统采用客户/服务器方式
* 电子邮件系统的三个主要组成构件：用户代理、邮件服务器、以及电子邮件所需的协议
  * 用户代理是用户与电子邮件系统的接口，又称为电子邮件客户端软件。
  * 邮件服务器是电子邮件系统的基础设施。因特网上所有的ISP都有邮件服务器，其功能是发送和接收邮件，同时还要负责维护用户的邮箱。
  * 协议包括邮件发送协议(SMTP)和邮件读取协议(POP3，IMAP)

![image-20210513084644191](https://i.loli.net/2021/05/13/Gj9DhOPso7vdAmu.png)

### 简单邮件传送协议SMTP(Simple Mail Transcer Protocol)的基本工作原理

![image-20210513085242348](https://i.loli.net/2021/05/13/SVPHlNIEOwvYDt2.png)

### 信息格式

![image-20210513085328773](https://i.loli.net/2021/05/13/DHp2syGkWgM8SnL.png)

![image-20210513085446105](https://i.loli.net/2021/05/13/c2od5nReMXsxNlP.png)

![image-20210513085430451](https://i.loli.net/2021/05/13/t1HykSsjWzuJ487.png)

![image-20210513085710708](https://i.loli.net/2021/05/13/VDE1sxKXPwYc9Tl.png)

![image-20210513085729506](https://i.loli.net/2021/05/13/WKXmwd3AaQIr257.png)

![image-20210513085922823](https://i.loli.net/2021/05/13/JAOtUjIKxWy7dpz.png)

![image-20210513090003780](https://i.loli.net/2021/05/13/qFQJdfuwcoYnRSm.png)

![image-20210513090042010](https://i.loli.net/2021/05/13/y9XctSTiUwL2NFV.png)

![image-20210513090052606](https://i.loli.net/2021/05/13/WGs9jzrgHcx2Q6D.png)

### 万维网

![image-20210513093419342](https://i.loli.net/2021/05/13/8cs9JYEo2VbnONX.png)

![image-20210513093512834](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513093512834.png)

![image-20210513093621765](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513093621765.png)

#### 万维网文档

![image-20210513093731344](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513093731344.png)

![image-20210513093747397](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513093747397.png)

#### 超文本传输协议HTTP(HyperText Transfer Protocol)

![image-20210513093940339](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513093940339.png)

![image-20210513094155427](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094155427.png)

![image-20210513094209496](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094209496.png)

#### HTTP报文格式

##### 请求报文

![image-20210513094303412](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094303412.png)

![image-20210513094319324](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094319324.png)

##### 响应报文

![image-20210513094430891](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094430891.png)

![image-20210513094457395](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094457395.png)

#### Cookie

![image-20210513094549830](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094549830.png)

##### 工作原理

![image-20210513094922830](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513094922830.png)

#### 万维网缓存与代理服务器

![image-20210513095131158](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513095131158.png)

如果原始服务器中的文档被更改了，而代理服务器还是原来那个怎么办？

原始服务器会为每个响应字段设置一个修改时间字段Last-Modified和一个有效日期字段Expires。

 主机向代理服务器发送请求。

* 代理服务器将未过期的文档封装在响应报文中发回主机
* 如果已过期，则代理服务器向原始服务器发送一个请求。请求报文中包含有一个首部字段为if-modified-since的首部行，该字段的取值就是该文档的修改日期，根据这个修改日期就可以判断原始服务器中的文档与代理服务器中的文档是否一致。
  * 一致，就发送不包含实体主体的响应，状态码为304，短语为Not Modified，代理服务器重新更新其文档有效日期封装在响应报文中发送给主机。
  * 不一致，原始服务器则给代理服务器发送封装有该文档的响应报文，代理服务器更新了该文档。然后将更新后的该文档封装在响应报文中发回给主机。

![image-20210513095451162](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513095451162.png)

 

![image-20210513100623036](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513100623036.png)

![image-20210513100713186](C:\Users\31787\AppData\Roaming\Typora\typora-user-images\image-20210513100713186.png)